<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TwelveLabs Marengo - Multi-Modal Video Search</title>
    <link rel="icon" type="image/x-icon" href="/static/images/TL-favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Download format exports handled natively (no external libs) -->
    <script>
        (function() {
            var saved = localStorage.getItem('strand-dark-mode');
            var theme;
            if (saved !== null) {
                theme = saved === 'true' ? 'dark' : 'light';
            } else {
                theme = 'light';
            }
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <style>
        /* =============================================
           Strand Design System — CSS Custom Properties
           Source: packages/strand/tokens/colors.json
           ============================================= */
        :root,
        [data-theme="dark"] {
            /* Backgrounds */
            --bg-body: #1D1C1B;
            --bg-header: #2A2928;
            --bg-surface: #2A2928;
            --bg-surface-hover: #333231;
            --bg-input: #1D1C1B;
            --bg-deep: #1D1C1B;
            --bg-elevated: #333231;
            --bg-card: #333231;

            /* Borders */
            --border: #45423F;
            --border-light: #333231;
            --border-hover: #6B6966;
            --border-focus: #00DC82;

            /* Text */
            --text-primary: #F4F3F3;
            --text-secondary: #9B9895;
            --text-tertiary: #6B6966;
            --text-inverse: #1D1C1B;

            /* Accent — UI green (#00DC82), not brand green (#00FF00) */
            --accent: #00DC82;
            --accent-hover: #00B86E;
            --accent-light: #1A3D2A;
            --accent-muted: rgba(0, 220, 130, 0.15);

            /* Active/Selected in dark mode = Strand white variant (inverse of light mode black) */
            --active-bg: #F4F3F3;
            --active-text: #1D1C1B;

            /* Modality colors (product line) */
            --visual: #6CD5FD;
            --visual-bg: rgba(108, 213, 253, 0.15);
            --audio: #60E21B;
            --audio-bg: rgba(96, 226, 27, 0.15);
            --transcription: #FABA17;
            --transcription-bg: rgba(250, 186, 23, 0.15);

            /* Modality bar fills */
            --visual-fill: #6CD5FD;
            --audio-fill: #60E21B;
            --transcription-fill: #FABA17;

            /* System */
            --error: #E22622;
            --warning: #FABA17;
            --success: #60E21B;
            --info: #6CD5FD;

            /* Misc */
            --overlay: rgba(0, 0, 0, 0.85);
            --card-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            --gradient-brand: linear-gradient(90deg, #60E21B, #FABA17, #FFB0CD);

            /* Toggle */
            --toggle-off: #45423F;
            --toggle-on: #00DC82;

            /* Spinner */
            --spinner-track: #45423F;

            /* Syntax highlighting */
            --syntax-key: #6CD5FD;
            --syntax-string: #60E21B;
            --syntax-number: #FABA17;
            --syntax-boolean: #FFB592;
            --syntax-null: #9B9895;

            /* Layout */
            --sidebar-width: 240px;
            --sidebar-collapsed-width: 56px;
            --header-height: auto;
        }

        [data-theme="light"] {
            --bg-body: #F4F3F3;
            --bg-header: #FFFFFF;
            --bg-surface: #FFFFFF;
            --bg-surface-hover: #ECECEC;
            --bg-input: #FFFFFF;
            --bg-deep: #F4F3F3;
            --bg-elevated: #ECECEC;
            --bg-card: #ECECEC;

            --border: #D3D1CF;
            --border-light: #E8E7E5;
            --border-hover: #9B9895;
            --border-focus: #00DC82;

            --text-primary: #1D1C1B;
            --text-secondary: #6B6966;
            --text-tertiary: #9B9895;
            --text-inverse: #FFFFFF;

            --accent: #00DC82;
            --accent-hover: #00B86E;
            --accent-light: #E8F5E9;
            --accent-muted: rgba(0, 220, 130, 0.1);

            /* Active/Selected in light mode = charcoal */
            --active-bg: #1D1C1B;
            --active-text: #F4F3F3;

            --visual: #366B7F;
            --visual-bg: rgba(108, 213, 253, 0.12);
            --audio: #30710E;
            --audio-bg: rgba(96, 226, 27, 0.12);
            --transcription: #7D5D0C;
            --transcription-bg: rgba(250, 186, 23, 0.12);

            --visual-fill: #6CD5FD;
            --audio-fill: #60E21B;
            --transcription-fill: #FABA17;

            --error: #E22622;
            --warning: #FABA17;
            --success: #60E21B;
            --info: #6CD5FD;

            --overlay: rgba(0, 0, 0, 0.5);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            --gradient-brand: linear-gradient(90deg, #60E21B, #FABA17, #FFB0CD);

            --toggle-off: #D3D1CF;
            --toggle-on: #00DC82;

            --spinner-track: #D3D1CF;

            --syntax-key: #366B7F;
            --syntax-string: #30710E;
            --syntax-number: #7D5D0C;
            --syntax-boolean: #805B49;
            --syntax-null: #9B9895;
        }

        /* =============================================
           Base Styles — Strand Typography
           ============================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 14px;
            line-height: 1.5;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas:
                "sidebar header"
                "sidebar content";
        }

        body.sidebar-collapsed {
            --sidebar-width: var(--sidebar-collapsed-width);
        }

        body.sidebar-collapsed .sidebar {
            padding: 8px 0;
            justify-content: flex-start;
        }

        /* =============================================
           Sidebar — TwelveLabs Platform Navigation
           ============================================= */
        .sidebar {
            grid-area: sidebar;
            position: sticky;
            top: 0;
            height: 100vh;
            background: var(--bg-header);
            border-right: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 12px 8px;
            transition: background-color 0.2s ease;
            overflow: hidden;
            z-index: 90;
        }

        .sidebar-top {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-bottom {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 12px;
        }

        .sidebar-logo img {
            height: 24px;
            width: auto;
            object-fit: contain;
        }

        .sidebar-logo .bedrock-logo {
            height: 22px;
        }

        .sidebar-logo .separator {
            width: 1px;
            height: 24px;
            background: var(--border);
            flex-shrink: 0;
        }

        /* Show dark logo on light bg, light logo on dark bg */
        [data-theme="light"] .logo-for-light { display: block; }
        [data-theme="light"] .logo-for-dark { display: none; }
        [data-theme="dark"] .logo-for-light { display: none; }
        [data-theme="dark"] .logo-for-dark { display: block; }

        [data-theme="light"] .sidebar-logo .bedrock-logo {
            filter: brightness(0) saturate(100%);
        }

        .sidebar-section-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 8px 12px 4px;
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.2s ease;
        }

        .sidebar-explore-nav {
            position: relative;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            line-height: 20px;
            min-height: 36px;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            overflow: hidden;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-family: inherit;
            box-sizing: border-box;
        }

        .sidebar-nav-item:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .sidebar-nav-item.active {
            background: var(--active-bg);
            color: var(--active-text);
        }

        .sidebar-nav-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
        }

        .sidebar-nav-label {
            overflow: hidden;
            transition: opacity 0.2s ease, width 0.25s ease;
        }

        .sidebar-collapse-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            overflow: hidden;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            line-height: 20px;
            min-height: 36px;
            box-sizing: border-box;
        }

        .sidebar-collapse-btn:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .sidebar-collapse-icon {
            transition: transform 0.25s ease;
        }

        /* Copyright text */
        .sidebar-copyright {
            font-size: 11px;
            color: var(--text-tertiary);
            padding: 8px 12px 4px;
            white-space: nowrap;
            overflow: hidden;
        }

        /* Collapse icon: show X when expanded, hamburger when collapsed */
        .collapse-x { display: block; }
        .collapse-menu { display: none; }
        body.sidebar-collapsed .collapse-x { display: none; }
        body.sidebar-collapsed .collapse-menu { display: block; }

        /* Horse icon for collapsed sidebar */
        .sidebar-logo-horse {
            display: none;
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            color: var(--text-primary);
        }

        /* Collapsed sidebar */
        body.sidebar-collapsed .sidebar-nav-label {
            display: none;
        }

        body.sidebar-collapsed .sidebar-copyright {
            display: none;
        }

        body.sidebar-collapsed .sidebar-logo .separator,
        body.sidebar-collapsed .sidebar-logo .bedrock-logo,
        body.sidebar-collapsed .sidebar-logo .logo-for-light,
        body.sidebar-collapsed .sidebar-logo .logo-for-dark {
            display: none !important;
        }

        body.sidebar-collapsed .sidebar-logo-horse {
            display: block;
        }

        body.sidebar-collapsed .sidebar-top {
            align-items: center;
            width: 100%;
        }

        body.sidebar-collapsed .sidebar-bottom {
            align-items: center;
            width: 100%;
            margin-top: auto;
        }

        body.sidebar-collapsed .sidebar-nav {
            align-items: center;
            width: 100%;
        }

        body.sidebar-collapsed .sidebar-nav-item,
        body.sidebar-collapsed .sidebar-collapse-btn {
            justify-content: center;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            margin: 0;
        }

        body.sidebar-collapsed .sidebar-logo {
            justify-content: center;
            padding: 4px 0;
            margin-bottom: 4px;
        }

        body.sidebar-collapsed .sidebar-section-label {
            display: none;
        }

        /* Theme toggle icon — show sun in dark mode, moon in light mode */
        [data-theme="dark"] .theme-icon-sun { display: block; }
        [data-theme="dark"] .theme-icon-moon { display: none; }
        [data-theme="light"] .theme-icon-sun { display: none; }
        [data-theme="light"] .theme-icon-moon { display: block; }

        /* =============================================
           Header — Centered search bar
           ============================================= */
        header {
            grid-area: header;
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-header);
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s ease;
        }

        .header-top {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 20px;
            height: 56px;
            flex-shrink: 0;
        }

        .header-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            align-items: center;
            justify-content: center;
        }

        .header-menu-btn:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .header-search {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 640px;
            margin: 0 auto;
            position: relative;
        }

        .header-search-inner {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            height: 44px;
            overflow: hidden;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .header-search-inner:focus-within {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .header-search-input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 14px;
            outline: none;
            min-width: 0;
            padding: 0 0 0 16px;
            height: 100%;
        }

        .header-search-input::placeholder {
            color: var(--text-tertiary);
        }

        .header-search-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 4px;
            margin-right: 12px;
        }

        .header-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            border-radius: 6px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .header-action-btn:hover {
            color: var(--text-primary);
        }

        .header-search-submit {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 100%;
            background: var(--bg-surface);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }

        .header-search-submit:hover {
            color: var(--text-primary);
        }

        #imagePreview {
            display: none;
            align-items: center;
            gap: 2px;
            margin-left: 4px;
        }

        #imagePreview.active {
            display: flex;
        }

        #previewImg {
            height: 28px;
            width: 28px;
            border-radius: 4px;
            object-fit: cover;
        }

        #removeImage {
            padding: 2px;
            background: var(--error);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
        }

        #removeImage:hover {
            background: #9D422B;
        }

        .header-filter-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            height: 40px;
            padding: 0 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.15s ease;
        }
        .header-filter-btn .filter-chevron {
            transition: transform 0.2s ease;
        }
        .header-filter-btn.active .filter-chevron {
            transform: rotate(180deg);
        }

        .header-filter-btn:hover,
        .header-filter-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-muted);
        }

        /* =============================================
           Header Right — Upload, Theme, User
           ============================================= */
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .header-upload-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 20px 8px 14px;
            border-radius: 12px;
            border: none;
            background: var(--active-bg);
            color: var(--active-text);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: opacity 0.15s;
        }

        .header-upload-btn:hover {
            opacity: 0.85;
        }

        .header-icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .header-icon-btn:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .header-avatar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--accent);
            color: var(--text-inverse);
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .header-avatar-btn:hover {
            opacity: 0.85;
        }

        /* =============================================
           Search Options Panel (Filter Dropdown)
           ============================================= */
        .search-options-panel {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 280px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 300;
        }

        .search-options-panel.open {
            display: block;
        }

        .search-options-panel-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .search-option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .search-option-row + .search-option-row {
            border-top: 1px solid var(--border-light);
        }

        .search-option-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .search-option-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* =============================================
           Category Pills (Search Modes)
           ============================================= */
        .category-pills-row {
            display: flex;
            align-items: center;
            padding: 0 20px 12px;
            gap: 12px;
        }

        .category-pills-center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .category-pills {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .pills-row-spacer {
            /* Matches .header-right width: 36px + 8px gap + 36px = 80px */
            width: 80px;
            flex-shrink: 0;
        }

        .category-pills::-webkit-scrollbar {
            display: none;
        }

        .decomposition-inline-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            padding: 4px 0;
        }

        .decomposition-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .category-pill {
            padding: 8px 18px;
            border-radius: 12px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 200ms ease, color 200ms ease, border-radius 200ms ease;
            white-space: nowrap;
            flex-shrink: 0;
            outline: none;
        }

        .category-pill:hover {
            color: var(--text-primary);
            background: var(--bg-surface-hover);
            border-radius: 16px;
        }

        .category-pill.active {
            background: var(--active-bg);
            color: var(--active-text);
            font-weight: 600;
        }

        /* =============================================
           Analyze View — Search within Video
           ============================================= */
        .analyze-view {
            display: flex;
            height: calc(100vh - 56px);
        }

        .analyze-sidebar {
            width: 280px;
            border-right: 1.3px solid var(--border-light);
            display: flex;
            flex-direction: column;
            background: var(--bg-surface);
            flex-shrink: 0;
        }

        .analyze-sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .analyze-sidebar-header h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .analyze-asset-list {
            overflow-y: auto;
            flex: 1;
            padding: 8px;
        }

        .analyze-folder-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            color: var(--text-primary);
        }
        .analyze-folder-item:hover { background: var(--bg-surface-hover); }
        .analyze-folder-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border-radius: 6px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        .analyze-folder-info { display: flex; flex-direction: column; gap: 1px; flex: 1; min-width: 0; }
        .analyze-folder-name { font-size: 13px; font-weight: 500; }
        .analyze-folder-count { font-size: 11px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace; }

        .analyze-back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 12px;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 4px;
            transition: color 0.15s;
        }
        .analyze-back-btn:hover { color: var(--text-primary); }

        .analyze-video-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .analyze-video-item:hover { background: var(--bg-surface-hover); }
        .analyze-video-item.active { background: var(--active-bg); color: var(--active-text); }

        .analyze-video-thumb {
            width: 64px;
            height: 36px;
            border-radius: 4px;
            object-fit: cover;
            background: #0f0f0f;
            flex-shrink: 0;
        }

        .analyze-video-name {
            font-size: 13px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }

        /* Sidebar tabs (Assets / History) */
        .analyze-sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-light);
        }
        .analyze-sidebar-tab {
            flex: 1;
            padding: 10px 0;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            color: var(--text-tertiary);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }
        .analyze-sidebar-tab:hover { color: var(--text-secondary); }
        .analyze-sidebar-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--active-bg);
        }

        /* History list */
        .chat-history-list {
            overflow-y: auto;
            flex: 1;
            padding: 8px;
            display: none;
        }
        .chat-history-list.visible { display: flex; flex-direction: column; }

        .chat-history-new-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 12px;
            margin: 0 0 4px 0;
            border-radius: 8px;
            border: 1px dashed var(--border);
            background: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            transition: all 0.15s;
        }
        .chat-history-new-btn:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
            border-color: var(--text-tertiary);
        }

        .chat-history-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }
        .chat-history-item:hover { background: var(--bg-surface-hover); }
        .chat-history-item.active { background: var(--active-bg); color: var(--active-text); }

        .chat-history-item-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .chat-history-item-title {
            font-size: 13px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-history-item-meta {
            font-size: 11px;
            color: var(--text-tertiary);
            font-family: 'IBM Plex Mono', monospace;
        }
        .chat-history-item.active .chat-history-item-meta { color: inherit; opacity: 0.7; }

        .chat-history-item-delete {
            display: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            background: none;
            color: var(--text-tertiary);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .chat-history-item:hover .chat-history-item-delete { display: flex; }
        .chat-history-item-delete:hover { background: var(--bg-elevated); color: #ef4444; }

        .chat-history-empty {
            padding: 24px 12px;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 13px;
        }

        .analyze-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .analyze-preview {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            position: relative;
        }

        .analyze-preview-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }
        .analyze-preview-clear:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .analyze-preview-video {
            width: 160px;
            aspect-ratio: 16/9;
            border-radius: 8px;
            object-fit: cover;
            background: #0f0f0f;
        }

        .analyze-preview-info { display: flex; flex-direction: column; gap: 4px; }
        .analyze-preview-name { font-size: 14px; font-weight: 600; }
        .analyze-preview-meta { font-size: 12px; color: var(--text-tertiary); }

        /* Chat container */
        .analyze-chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .analyze-chat-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-tertiary);
        }

        /* Chat messages */
        .chat-message {
            max-width: 88%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
        }
        .chat-msg-toolbar {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .chat-message:hover .chat-msg-toolbar { opacity: 1; }
        .chat-msg-toolbar button {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 3px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        .chat-msg-toolbar button:hover { color: var(--text-primary); background: var(--bg-hover); }
        .chat-msg-toolbar button.copied { color: var(--accent); }
        .chat-message.user .chat-msg-toolbar { justify-content: flex-end; }
        .chat-message.user .chat-msg-toolbar button { color: var(--active-text); opacity: 0.6; }
        .chat-msg-toolbar button:hover { opacity: 1; background: rgba(255,255,255,0.15); }
        .chat-msg-toolbar .dl-sep {
            width: 1px;
            height: 14px;
            background: var(--border-light);
            margin: 0 2px;
            align-self: center;
        }
        .chat-msg-toolbar .dl-btn {
            font-size: 9px;
            font-weight: 600;
            font-family: 'SF Mono', 'Fira Code', monospace;
            letter-spacing: 0.3px;
            padding: 2px 5px;
            border-radius: 3px;
            border: 1px solid var(--border-light);
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
        }
        .chat-msg-toolbar .dl-btn:hover {
            color: var(--text-primary);
            border-color: var(--border-hover);
            background: var(--bg-hover);
        }
        .chat-message.user .chat-msg-toolbar button:hover { opacity: 1; background: rgba(255,255,255,0.15); }
        .chat-message.user {
            align-self: flex-end;
            background: var(--active-bg);
            color: var(--active-text);
            border-bottom-right-radius: 4px;
        }
        .chat-message.assistant {
            align-self: flex-start;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-bottom-left-radius: 4px;
            max-width: 92%;
        }
        .chat-message.assistant.error {
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Chat result cards row */
        .chat-results-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .chat-results-row {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 6px;
        }
        .chat-results-row::-webkit-scrollbar { height: 4px; }
        .chat-results-row::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .chat-result-card {
            min-width: 160px;
            max-width: 180px;
            flex-shrink: 0;
            background: var(--bg-elevated);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid transparent;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .chat-result-card:hover {
            border-color: var(--border-light);
            box-shadow: var(--card-shadow);
        }

        .chat-result-thumb {
            position: relative;
            aspect-ratio: 16/9;
            background: #0f0f0f;
            overflow: hidden;
            cursor: pointer;
        }
        .chat-result-thumb video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-result-rank {
            position: absolute;
            top: 6px;
            left: 6px;
            background: var(--active-bg);
            color: var(--active-text);
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }
        .chat-result-confidence {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }
        .chat-result-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: rgba(0,0,0,0.85);
            color: #fff;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'IBM Plex Mono', monospace;
        }
        .chat-result-actions {
            padding: 6px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-result-seg {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 500;
        }
        .chat-result-quote-btn {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            letter-spacing: 0.2px;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .chat-result-quote-btn:hover {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        .chat-result-quote-btn svg {
            width: 10px;
            height: 10px;
            flex-shrink: 0;
        }

        /* Quoted segment bar */
        .chat-quoted-bar {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-surface);
            font-size: 13px;
        }
        .chat-quoted-bar.visible { display: flex; }
        .chat-quoted-list {
            flex: 1;
            display: flex;
            gap: 6px;
            overflow-x: auto;
            min-width: 0;
        }
        .chat-quoted-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            flex-shrink: 0;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .chat-quoted-chip video {
            width: 36px;
            height: 20px;
            border-radius: 3px;
            object-fit: cover;
            background: #0f0f0f;
        }
        .chat-quoted-chip-remove {
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            padding: 0;
        }
        .chat-quoted-chip-remove:hover { color: var(--text-primary); }
        .chat-quoted-dismiss {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .chat-quoted-dismiss:hover { background: var(--bg-surface-hover); color: var(--text-primary); }

        /* Pegasus text */
        .chat-pegasus-text { white-space: pre-wrap; }

        /* Loading dots */
        .chat-loading-dots { display: flex; gap: 4px; padding: 4px 0; }
        .chat-loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--text-tertiary);
            border-radius: 50%;
            animation: chatDotPulse 1.4s infinite ease-in-out;
        }
        .chat-loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .chat-loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes chatDotPulse {
            0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }

        /* User message with quoted reference */
        .chat-user-quote-ref {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        /* Input area */
        /* Model selector pills */
        .chat-model-selector {
            display: flex;
            gap: 6px;
            padding: 8px 16px;
            border-top: 1px solid var(--border-light);
        }
        .chat-model-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-tertiary);
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
        }
        .chat-model-btn:hover {
            color: var(--text-secondary);
            border-color: var(--border-hover);
        }
        .chat-model-btn.active {
            background: var(--active-bg);
            color: var(--active-text);
            border-color: var(--active-bg);
        }
        .chat-model-btn svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }
        .chat-session-cost {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.15s;
            align-self: center;
            position: relative;
        }
        .chat-session-cost:hover {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }
        .chat-cost-label {
            font-family: inherit;
            font-weight: 500;
        }
        .chat-cost-value {
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        .chat-cost-breakdown {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            right: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            min-width: 200px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 100;
            font-size: 12px;
        }
        .chat-cost-breakdown.open { display: block; }
        .chat-cost-breakdown-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chat-cost-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            color: var(--text-secondary);
        }
        .chat-cost-row .cost-svc {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chat-cost-row .cost-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .chat-cost-row .cost-amt {
            font-family: 'SF Mono', 'Fira Code', monospace;
            color: var(--text-tertiary);
        }
        .chat-cost-row.total {
            border-top: 1px solid var(--border-light);
            margin-top: 6px;
            padding-top: 6px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .chat-cost-row.total .cost-amt {
            color: var(--text-primary);
        }

        /* Chat settings panel */
        .chat-settings-panel {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 12px 16px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-surface);
        }
        .chat-settings-panel.open { display: flex; }
        .chat-settings-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chat-settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }
        .chat-settings-label {
            color: var(--text-secondary);
        }
        .chat-settings-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-settings-indicator {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .chat-settings-select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
        }
        .chat-settings-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }
        .chat-settings-btn:hover {
            color: var(--text-primary);
            border-color: var(--border-hover);
        }
        .chat-settings-btn.active {
            color: var(--accent);
            border-color: var(--accent);
        }

        .chat-image-preview {
            display: none;
            align-items: center;
            gap: 2px;
        }
        .chat-image-preview.active {
            display: flex;
        }
        .chat-image-preview img {
            height: 28px;
            width: 28px;
            border-radius: 4px;
            object-fit: cover;
        }
        .chat-image-preview button {
            padding: 2px;
            background: var(--error);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: -6px;
            margin-top: -18px;
        }

        /* Chat search mode pills */
        .chat-mode-pills {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .chat-mode-pill {
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-tertiary);
            font-size: 11px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
        }
        .chat-mode-pill:hover {
            color: var(--text-secondary);
            border-color: var(--border-hover);
        }
        .chat-mode-pill.active {
            background: var(--active-bg);
            color: var(--active-text);
            border-color: var(--active-bg);
        }

        /* Tool call details */
        .chat-tool-details {
            margin-top: 8px;
            border-top: 1px solid var(--border-light);
            padding-top: 8px;
        }
        .chat-tool-details summary {
            font-size: 11px;
            color: var(--text-tertiary);
            cursor: pointer;
            user-select: none;
        }
        .chat-tool-details summary:hover { color: var(--text-secondary); }
        .chat-tool-call {
            font-size: 11px;
            color: var(--text-tertiary);
            padding: 4px 0;
            font-family: 'IBM Plex Mono', monospace;
        }
        .chat-tool-name {
            color: var(--accent);
            font-weight: 500;
        }

        /* Asset result cards */
        .chat-asset-card {
            min-width: 180px;
            max-width: 200px;
            flex-shrink: 0;
            background: var(--bg-elevated);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid transparent;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .chat-asset-card:hover {
            border-color: var(--border-light);
            box-shadow: var(--card-shadow);
        }
        .chat-asset-info {
            padding: 8px;
        }
        .chat-asset-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-asset-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 2px;
        }
        .chat-asset-meta {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .chat-asset-duration {
            font-size: 10px;
            color: var(--text-tertiary);
            font-family: 'IBM Plex Mono', monospace;
        }

        /* Expandable segments within asset card */
        .chat-asset-segments-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px 8px;
            border-top: 1px solid var(--border-light);
            background: transparent;
            border-left: none;
            border-right: none;
            border-bottom: none;
            width: 100%;
            font-family: inherit;
            transition: color 0.15s;
        }
        .chat-asset-segments-toggle:hover { color: var(--text-secondary); }
        .chat-asset-segments-toggle svg {
            transition: transform 0.2s;
        }
        .chat-asset-segments-toggle.open svg {
            transform: rotate(90deg);
        }
        .chat-asset-segments-list {
            display: none;
            padding: 0 8px 6px;
            max-height: 150px;
            overflow-y: auto;
        }
        .chat-asset-segments-list.open { display: block; }
        .chat-asset-seg-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background 0.1s;
        }
        .chat-asset-seg-item:hover {
            background: var(--bg-surface-hover);
        }
        .chat-asset-seg-item .seg-label {
            white-space: nowrap;
        }
        .chat-asset-seg-item .seg-time {
            font-family: 'IBM Plex Mono', monospace;
            color: var(--text-tertiary);
            font-size: 10px;
            white-space: nowrap;
        }
        .chat-asset-seg-item .seg-score {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-tertiary);
            white-space: nowrap;
            margin-left: auto;
        }
        .chat-asset-seg-item .chat-result-modality-bars {
            flex: 1;
            padding: 0;
            min-width: 40px;
        }
        .seg-select-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-tertiary);
            font-size: 12px;
            font-weight: 700;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.15s;
            font-family: inherit;
            padding: 0;
        }
        .seg-select-btn:hover {
            background: var(--active-bg);
            color: white;
            border-color: var(--active-bg);
        }
        .chat-asset-segments-list::-webkit-scrollbar { width: 3px; }
        .chat-asset-segments-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* Modality bars on chat result cards */
        .chat-result-modality-bars {
            display: flex;
            gap: 2px;
            padding: 0 8px 6px;
        }
        .chat-result-modality-bars .modality-bar {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: var(--border);
            overflow: hidden;
        }

        /* Quoted bar chips: asset vs segment differentiation */
        .chat-quoted-chip.asset-chip {
            border-color: var(--active-bg);
            background: color-mix(in srgb, var(--active-bg) 10%, var(--bg-elevated));
        }
        .chat-quoted-chip:not(.asset-chip) {
            border-color: #6366f1;
            background: color-mix(in srgb, #6366f1 8%, var(--bg-elevated));
        }
        .chat-quoted-chip .chip-type-badge {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding: 1px 4px;
            border-radius: 3px;
            font-family: 'IBM Plex Mono', monospace;
        }
        .chip-type-badge.clip { background: #6366f1; color: #fff; }
        .chip-type-badge.asset { background: var(--active-bg); color: var(--active-text); }

        /* Clip result (subclip / concatenation) */
        .chat-clip-result {
            max-width: 400px;
        }
        .chat-clip-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }
        .chat-clip-player {
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
        }
        .chat-clip-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .chat-clip-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.15s;
        }
        .chat-clip-action-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .chat-clip-action-btn.success {
            background: #22c55e;
            color: white;
            border-color: #22c55e;
        }
        .chat-clip-action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .chat-clip-publish-row {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            padding-top: 8px;
            border-top: 1px solid var(--border-light);
        }
        .chat-clip-publish-row .publish-label {
            font-size: 11px;
            color: var(--text-tertiary);
            align-self: center;
            margin-right: 2px;
        }
        .chat-publish-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.15s;
        }
        .chat-publish-btn:hover { opacity: 0.85; }
        .chat-publish-btn.youtube:hover { background: #ff0000; color: white; border-color: #ff0000; }
        .chat-publish-btn.x:hover { background: #000; color: white; border-color: #000; }
        [data-theme="dark"] .chat-publish-btn.x:hover { background: #fff; color: #000; border-color: #fff; }
        .chat-publish-btn.vimeo:hover { background: #1ab7ea; color: white; border-color: #1ab7ea; }
        .chat-publish-btn svg { width: 14px; height: 14px; flex-shrink: 0; }

        .analyze-input-area {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border-light);
        }

        .analyze-input {
            flex: 1;
            padding: 10px 16px;
            border-radius: 24px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }
        .analyze-input:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .analyze-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--active-bg);
            color: var(--active-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: opacity 0.15s;
        }
        .analyze-send-btn:hover { opacity: 0.85; }

        #homeView {
            padding: 24px 32px;
        }

        /* =============================================
           Indexes View
           ============================================= */
        .indexes-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .indexes-breadcrumb-link {
            color: var(--text-tertiary);
            cursor: pointer;
            transition: color 0.15s;
        }
        .indexes-breadcrumb-link:hover { color: var(--text-primary); }
        .indexes-breadcrumb-separator { color: var(--text-tertiary); }
        .indexes-breadcrumb-current { font-weight: 600; color: var(--text-primary); }

        .indexes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        .index-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: border-color 200ms ease, box-shadow 200ms ease, border-radius 200ms ease;
        }
        .index-card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--card-shadow);
            border-radius: 16px;
        }
        .index-card-icon {
            width: 56px;
            height: 56px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
            background: var(--bg-elevated);
        }
        .index-card-icon.no-thumbs {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .index-card-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .index-card-thumb-placeholder {
            background: var(--bg-elevated);
        }
        .index-card-info { display: flex; flex-direction: column; gap: 2px; }
        .index-card-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .index-card-meta { font-size: 12px; color: var(--text-tertiary); }
        .index-card-count { font-size: 12px; color: var(--text-secondary); font-family: 'IBM Plex Mono', monospace; }

        .indexes-video-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .index-video-card {
            background: var(--bg-surface);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid transparent;
            cursor: pointer;
            transition: transform 200ms ease, box-shadow 200ms ease, border-color 200ms ease;
        }
        .index-video-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
            border-color: var(--border-light);
        }
        .index-video-thumb {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            background: #0f0f0f;
        }
        .index-video-info { padding: 12px; }
        .index-video-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .index-video-segments {
            font-size: 11px;
            color: var(--text-tertiary);
            font-family: 'IBM Plex Mono', monospace;
            margin-top: 4px;
        }

        .index-video-card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }
        .index-video-card.selected .index-video-check {
            display: flex;
        }
        .index-video-check {
            display: none;
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            color: #fff;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            z-index: 2;
        }
        .index-video-card .index-video-thumb-wrap {
            position: relative;
        }
        .indexes-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 0 16px 0;
        }
        .indexes-toolbar-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-surface);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 150ms ease;
        }
        .indexes-toolbar-btn:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }
        .indexes-toolbar-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }
        .indexes-toolbar-btn.danger {
            background: #dc3545;
            border-color: #dc3545;
            color: #fff;
        }
        .indexes-toolbar-btn.danger:hover {
            background: #c82333;
        }
        .indexes-toolbar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .indexes-toolbar-count {
            font-size: 13px;
            color: var(--text-tertiary);
            font-family: 'IBM Plex Mono', monospace;
        }
        .indexes-toolbar-spacer { flex: 1; }
        .confirm-overlay {
            position: fixed;
            inset: 0;
            z-index: 1100;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .confirm-box {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .confirm-box h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: var(--text-primary);
        }
        .confirm-box p {
            margin: 0 0 20px 0;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .confirm-box .confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .confirm-box .confirm-btn {
            padding: 8px 18px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-surface);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }
        .confirm-box .confirm-btn.danger {
            background: #dc3545;
            border-color: #dc3545;
            color: #fff;
        }

        @media (max-width: 900px) {
            .indexes-grid { grid-template-columns: 1fr; }
            .indexes-video-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* =============================================
           Main Content
           ============================================= */
        main {
            grid-area: content;
            padding: 0;
            overflow-y: auto;
            transition: background-color 0.2s ease;
            border-left: 1.3px solid var(--border-light);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .results-count {
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .query-display {
            font-size: 20px;
            color: var(--text-secondary);
        }

        /* =============================================
           Results Grid & Cards — Strand card pattern
           ============================================= */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .result-card {
            background: var(--bg-surface);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            border: 1px solid transparent;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
            border-color: var(--border-light);
        }

        .thumbnail-container {
            position: relative;
            aspect-ratio: 16/9;
            background: #0f0f0f;
            overflow: hidden;
        }

        .thumbnail-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .thumbnail-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: var(--text-tertiary);
            font-size: 3rem;
            position: absolute;
            top: 0;
            left: 0;
        }

        .thumbnail-placeholder.hidden {
            display: none;
        }

        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .result-card:hover .play-overlay {
            opacity: 1;
        }

        .play-overlay svg {
            width: 20px;
            height: 20px;
            margin-left: 2px;
        }

        .duration-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .score-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--accent);
            color: var(--text-inverse);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .rank-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--accent);
            color: var(--text-inverse);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            min-width: 28px;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
        }

        .confidence-badge {
            position: absolute;
            top: 40px;
            right: 8px;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }

        .confidence-value {
            color: #fff;
        }

        .card-info {
            padding: 12px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }

        .card-meta {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .meta-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
        }

        .meta-tag.visual { background: var(--visual-bg); color: var(--visual); }
        .meta-tag.audio { background: var(--audio-bg); color: var(--audio); }
        .meta-tag.transcription { background: var(--transcription-bg); color: var(--transcription); }

        /* =============================================
           Video Modal — Strand modal pattern
           ============================================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background: var(--bg-surface);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 500;
        }

        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .modal-speed-control {
            display: flex;
            gap: 2px;
            background: var(--bg-elevated);
            border-radius: 6px;
            padding: 2px;
        }
        .modal-speed-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 11px;
            font-family: 'IBM Plex Mono', monospace;
            padding: 3px 7px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .modal-speed-btn:hover { color: var(--text-primary); }
        .modal-speed-btn.active {
            background: var(--bg-surface);
            color: var(--text-primary);
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        .modal-download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            color: var(--text-secondary);
            transition: all 0.15s;
        }
        .modal-download-btn:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .video-container {
            flex: 1;
            min-height: 0;
            background: #000;
            overflow: hidden;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .modal-info {
            padding: 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* =============================================
           Loading & Empty States
           ============================================= */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 64px;
            color: var(--text-secondary);
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--spinner-track);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 64px;
            color: var(--text-tertiary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* =============================================
           Weights & Dynamic Panels — Strand surface
           ============================================= */
        .weights-panel {
            background: var(--bg-surface);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            border: 1px solid var(--border-light);
        }

        .weights-panel.active {
            display: block;
        }

        .weights-panel-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .weight-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .weight-label {
            width: 100px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .weight-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 4px;
            background: var(--border);
        }

        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 8px;
            background: var(--accent);
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .weight-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .weight-value {
            width: 50px;
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
        }

        .dynamic-weights-panel {
            background: var(--bg-surface);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            border: 1px solid var(--border-light);
        }

        .dynamic-weights-panel.active {
            display: block;
        }

        .dynamic-weight-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .dynamic-weight-label {
            width: 100px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .dynamic-weight-bar-container {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .dynamic-weight-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .dynamic-weight-bar-fill.visual { background: var(--visual-fill); }
        .dynamic-weight-bar-fill.audio { background: var(--audio-fill); }
        .dynamic-weight-bar-fill.transcription { background: var(--transcription-fill); }

        .dynamic-weight-value {
            width: 50px;
            text-align: right;
            font-size: 12px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .dynamic-weight-value.visual { color: var(--visual); }
        .dynamic-weight-value.audio { color: var(--audio); }
        .dynamic-weight-value.transcription { color: var(--transcription); }

        /* Dominant modality indicator */
        .dominant-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            font-family: 'IBM Plex Mono', monospace;
        }

        .dominant-indicator.visual { background: rgba(108, 213, 253, 0.9); color: #1D1C1B; }
        .dominant-indicator.audio { background: rgba(96, 226, 27, 0.9); color: #1D1C1B; }
        .dominant-indicator.transcription { background: rgba(250, 186, 23, 0.9); color: #1D1C1B; }

        /* Modality score bars in cards */
        .modality-bars {
            display: flex;
            gap: 2px;
            margin-top: 8px;
        }

        .modality-bar {
            flex: 1;
            height: 3px;
            border-radius: 2px;
            background: var(--border);
            overflow: hidden;
        }

        .modality-bar-fill {
            height: 100%;
            transition: width 0.2s ease;
        }

        .modality-bar-fill.visual { background: var(--visual-fill); }
        .modality-bar-fill.audio { background: var(--audio-fill); }
        .modality-bar-fill.transcription { background: var(--transcription-fill); }

        /* =============================================
           Backend, Index, Decomposition Controls (in dropdown)
           ============================================= */
        .backend-dropdown {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px 8px;
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 12px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
        }

        .backend-dropdown:hover {
            border-color: var(--accent);
        }

        .backend-dropdown:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .index-mode-indicator {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            font-family: 'IBM Plex Mono', monospace;
        }

        /* =============================================
           Decomposed Queries
           ============================================= */
        .decomposed-queries {
            display: none;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .decomposed-queries.visible {
            display: block;
        }

        .decomposed-queries-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .decomposed-query-item {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .decomposed-query-item:last-child {
            margin-bottom: 0;
        }

        .decomposed-query-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .decomposed-query-text {
            font-size: 14px;
            color: var(--text-primary);
        }

        /* =============================================
           Toggle Switch — Strand pattern
           ============================================= */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-off);
            transition: 0.2s ease;
            border-radius: 12px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #fff;
            transition: 0.2s ease;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--toggle-on);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-switch input:not(:checked) + .toggle-slider {
            background-color: var(--toggle-off);
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Fusion/Single Mode Labels */
        .fusion-label, .single-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .fusion-label {
            background: var(--accent-muted);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .single-label {
            background: transparent;
            color: var(--text-tertiary);
        }

        /* =============================================
           Code Inspection Modal
           ============================================= */
        .code-inspection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .code-inspection-modal.active {
            display: flex;
        }

        .code-modal-content {
            width: 90%;
            max-width: 1400px;
            height: 80vh;
            background: var(--bg-surface);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        .code-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-elevated);
        }

        .code-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .code-modal-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .code-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-surface);
            color: var(--text-secondary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .code-btn:hover {
            background: var(--bg-surface-hover);
            border-color: var(--border-hover);
            border-radius: 10px;
        }

        .code-btn.primary {
            background: var(--active-bg);
            border-color: var(--active-bg);
            color: var(--active-text);
        }

        .code-btn.primary:hover {
            background: var(--accent);
            color: var(--text-inverse);
            border-radius: 10px;
        }

        .code-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .code-modal-close:hover {
            color: var(--text-primary);
            background: var(--bg-surface-hover);
        }

        .code-tabs {
            display: flex;
            gap: 0;
            padding: 0 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-elevated);
        }

        .code-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .code-tab:hover {
            color: var(--text-primary);
        }

        .code-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .code-content-area {
            flex: 1;
            overflow: auto;
            padding: 24px;
            background: var(--bg-deep);
        }

        .code-panel {
            display: none;
        }

        .code-panel.active {
            display: block;
        }

        .code-block {
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
            overflow-x: auto;
            white-space: pre;
        }

        /* JSON Syntax Highlighting */
        .json-key { color: var(--syntax-key); }
        .json-string { color: var(--syntax-string); }
        .json-number { color: var(--syntax-number); }
        .json-boolean { color: var(--syntax-boolean); }
        .json-null { color: var(--syntax-null); }

        /* =============================================
           Show Code Button (FAB) — Strand black button
           ============================================= */
        .show-code-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 10px 18px;
            background: var(--active-bg);
            border: none;
            border-radius: 12px;
            color: var(--active-text);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }

        .show-code-btn.visible {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .show-code-btn:hover {
            background: var(--accent);
            color: var(--text-inverse);
            border-radius: 16px;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 220, 130, 0.3);
        }

        .show-code-btn svg {
            display: inline-block;
            vertical-align: middle;
        }

        /* =============================================
           Responsive
           ============================================= */
        @media (max-width: 1200px) {
            .results-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "content";
            }

            .sidebar {
                position: fixed;
                left: calc(-1 * var(--sidebar-width));
                top: 0;
                height: 100vh;
                width: var(--sidebar-width) !important;
                z-index: 500;
                transition: left 0.25s ease, background-color 0.2s ease;
            }

            .sidebar.sidebar-mobile-open {
                left: 0;
                box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
            }

            .header-menu-btn {
                display: flex;
            }

            header {
                padding: 0 12px;
                gap: 8px;
            }

            .header-search {
                max-width: none;
            }

            .sidebar-logo .separator,
            .sidebar-logo .bedrock-logo {
                display: none;
            }

            main {
                padding: 16px;
            }

            .category-pills-row {
                flex-direction: column;
                align-items: flex-start;
                padding: 0 0 12px 0;
            }

            .decomposition-inline-toggle {
                padding: 0 0 4px 0;
            }

            .results-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        @media (max-width: 480px) {
            .category-pill {
                padding: 4px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- =============================================
         Sidebar — TwelveLabs Platform Navigation
         ============================================= -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-top">
            <!-- Logo: TwelveLabs | Bedrock (full) / Horse icon (collapsed) -->
            <div class="sidebar-logo">
                <img src="/static/images/TL-logo-light.png" alt="TwelveLabs" class="logo-for-light">
                <img src="/static/images/TL-logo-dark.png" alt="TwelveLabs" class="logo-for-dark">
                <div class="separator"></div>
                <img src="/static/images/bedrock-logo.png" alt="Amazon Bedrock" class="bedrock-logo">
                <!-- Horse icon shown only when collapsed -->
                <svg class="sidebar-logo-horse" viewBox="0 0 50 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g fill="currentColor"><rect x="10.78" y="12.36" width="15.81" height="2.14" rx="0.63"/><rect x="0" y="12.36" width="8.66" height="2.14" rx="0.63"/><rect x="30.51" y="12.36" width="9.89" height="2.14" rx="0.63"/><rect x="31.93" y="9.28" width="8.47" height="2.15" rx="0.63"/><rect x="41.51" y="9.28" width="6.73" height="2.15" rx="0.63"/><rect x="38.65" y="6.14" width="7.66" height="2.15" rx="0.63"/><rect x="41.08" y="3.07" width="2.24" height="2.15" rx="0.63"/><rect x="18.26" y="27.71" width="3.9" height="2.15" rx="0.63"/><rect x="25.02" y="27.71" width="2.56" height="2.15" rx="0.63"/><rect x="28.74" y="27.71" width="6.88" height="2.15" rx="0.63"/><rect x="32.2" y="24.64" width="2.87" height="2.14" rx="0.63"/><rect x="12.88" y="27.71" width="2.24" height="2.15" rx="0.63"/><rect x="23.29" y="30.78" width="2.24" height="2.15" rx="0.63"/><rect x="21.09" y="33.86" width="2.15" height="2.14" rx="0.63"/><rect x="29.58" y="0" width="2.8" height="2.15" rx="0.63"/><rect x="13.71" y="9.28" width="7.14" height="2.15" rx="0.63"/><rect x="26.96" y="3.07" width="4.32" height="2.15" rx="0.63"/><rect x="24.29" y="6.14" width="6.99" height="2.15" rx="0.63"/><rect x="46.04" y="12.36" width="4.08" height="2.14" rx="0.63"/><rect x="7.52" y="15.43" width="20.15" height="2.15" rx="0.63"/><rect x="25.83" y="21.57" width="7.87" height="2.15" rx="0.63"/><rect x="10.78" y="18.5" width="25.62" height="2.15" rx="0.63"/><rect x="6.85" y="21.57" width="9.52" height="2.15" rx="0.63"/><rect x="15.56" y="24.64" width="3.11" height="2.14" rx="0.63"/><rect x="26.58" y="24.64" width="3.38" height="2.14" rx="0.63"/><rect x="9.79" y="24.64" width="3.17" height="2.14" rx="0.63"/><rect x="30.51" y="15.43" width="8.14" height="2.15" rx="0.63"/><rect x="32.4" y="6.12" width="2.24" height="2.15" rx="0.63"/></g>
                </svg>
            </div>

            <!-- Primary nav -->
            <nav class="sidebar-nav">
                <a href="#" class="sidebar-nav-item active" data-page="home">
                    <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                        <path d="M12 3L4 9v12h5v-7h6v7h5V9l-8-6z"/>
                    </svg>
                    <span class="sidebar-nav-label">Home</span>
                </a>
                <a href="#" class="sidebar-nav-item" data-page="examples">
                    <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 12.667 12.8438" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9.66699 6.84377C10.5002 6.84385 11.2087 7.13552 11.792 7.71877C12.3752 8.30205 12.6669 9.01056 12.667 9.84377C12.667 10.677 12.3751 11.3855 11.792 11.9688C11.2087 12.552 10.5002 12.8437 9.66699 12.8438C8.83368 12.8438 8.12532 12.5521 7.54199 11.9688C6.95866 11.3854 6.66699 10.6771 6.66699 9.84377C6.66704 9.01054 6.95871 8.30206 7.54199 7.71877C8.12527 7.13562 8.83379 6.84377 9.66699 6.84377ZM3.7334 7.17776C4.61702 7.1778 5.33301 7.89374 5.33301 8.77737V10.9102C5.33301 11.7938 4.61702 12.5107 3.7334 12.5108H1.59961C0.716134 12.5106 0 11.7937 0 10.9102V8.77737C0 7.89384 0.716133 7.17797 1.59961 7.17776H3.7334ZM9.66699 7.84377C9.09598 7.84377 8.64263 8.03232 8.24902 8.42581C7.85541 8.81942 7.66704 9.27274 7.66699 9.84377C7.66699 10.4149 7.85536 10.8681 8.24902 11.2617C8.64268 11.6554 9.09587 11.8438 9.66699 11.8438C10.238 11.8437 10.6914 11.6553 11.085 11.2617C11.4784 10.8681 11.667 10.4148 11.667 9.84377C11.6669 9.27276 11.4785 8.81941 11.085 8.42581C10.6914 8.03221 10.238 7.84385 9.66699 7.84377ZM1.59961 8.17776C1.26842 8.17797 1 8.44613 1 8.77737V10.9102C1 11.2414 1.26842 11.5106 1.59961 11.5108H3.7334C4.06474 11.5107 4.33301 11.2415 4.33301 10.9102V8.77737C4.33301 8.44602 4.06474 8.1778 3.7334 8.17776H1.59961ZM5.54492 0.254908C5.75293 -0.0849695 6.24707 -0.084969 6.45508 0.254908L9.1709 4.69924C9.38799 5.05459 9.13222 5.51068 8.71582 5.51077H3.28418C2.86778 5.51068 2.61201 5.05459 2.8291 4.69924L5.54492 0.254908ZM4.11621 4.51077H7.88379L6 1.42874L4.11621 4.51077Z"/>
                    </svg>
                    <span class="sidebar-nav-label">Examples</span>
                </a>
                <a href="#" class="sidebar-nav-item" data-page="indexes">
                    <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 12 10" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                    </svg>
                    <span class="sidebar-nav-label">Indexes</span>
                </a>
            </nav>

            <!-- Explore section -->
            <div class="sidebar-section-label">EXPLORE</div>
            <nav class="sidebar-nav sidebar-explore-nav">
                <a href="#" class="sidebar-nav-item" data-page="analyze">
                    <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 12 12" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M5 0C7.76142 0 10 2.23858 10 5C10 6.01926 9.69399 6.9672 9.16888 7.7545L11.7071 10.2929C12.0976 10.6834 12.0976 11.3166 11.7071 11.7071C11.3166 12.0976 10.6834 12.0976 10.2929 11.7071L7.7545 9.16888C6.9672 9.69399 6.01926 10 5 10C2.23858 10 0 7.76142 0 5C0 2.23858 2.23858 0 5 0ZM5 1C2.79086 1 1 2.79086 1 5C1 7.20914 2.79086 9 5 9C7.20914 9 9 7.20914 9 5C9 2.79086 7.20914 1 5 1ZM3.5 4C3.77614 4 4 4.22386 4 4.5V7C4 7.27614 3.77614 7.5 3.5 7.5C3.22386 7.5 3 7.27614 3 7V4.5C3 4.22386 3.22386 4 3.5 4ZM5 3C5.27614 3 5.5 3.22386 5.5 3.5V7C5.5 7.27614 5.27614 7.5 5 7.5C4.72386 7.5 4.5 7.27614 4.5 7V3.5C4.5 3.22386 4.72386 3 5 3ZM6.5 5C6.77614 5 7 5.22386 7 5.5V7C7 7.27614 6.77614 7.5 6.5 7.5C6.22386 7.5 6 7.27614 6 7V5.5C6 5.22386 6.22386 5 6.5 5Z"/>
                    </svg>
                    <span class="sidebar-nav-label">Analyze</span>
                </a>
            </nav>
        </div>

        <div class="sidebar-bottom">
            <!-- Copyright -->
            <div class="sidebar-copyright">&copy; 2026 TwelveLabs, Inc.</div>
            <!-- Collapse: X when expanded, hamburger when collapsed -->
            <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" title="Collapse sidebar">
                <svg class="sidebar-nav-icon sidebar-collapse-icon collapse-x" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <svg class="sidebar-nav-icon sidebar-collapse-icon collapse-menu" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
                <span class="sidebar-nav-label">Collapse</span>
            </button>
        </div>
    </aside>

    <!-- =============================================
         Header — Search bar + filter
         ============================================= -->
    <header>
        <div class="header-top">
        <!-- Hamburger for mobile -->
        <button class="header-menu-btn" id="headerMenuBtn" title="Toggle sidebar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <!-- Search bar -->
        <div class="header-search">
            <div class="header-search-inner">
                <input type="text" class="header-search-input" id="searchInput" placeholder="Search videos...">
                <div class="header-search-actions">
                    <label for="imageUpload" class="header-action-btn" title="Upload image for search">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </label>
                    <input type="file" id="imageUpload" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">
                    <div id="imagePreview">
                        <img id="previewImg" alt="Query image preview">
                        <button id="removeImage" title="Remove image" type="button">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <button class="header-search-submit" id="searchBtn" title="Search">
                    <svg width="18" height="18" viewBox="0 0 12 11.707" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.5 0C9.98528 0 12 2.01472 12 4.5C12 6.98528 9.98528 9 7.5 9C6.36252 8.99998 5.32451 8.57691 4.53223 7.88086L0.707031 11.707L0 11L3.85742 7.1416C3.31847 6.39969 3 5.48716 3 4.5C3 2.01474 5.01475 4.07169e-05 7.5 0ZM7.5 1C5.56704 1.00004 4 2.56703 4 4.5C4 6.43297 5.56704 7.99996 7.5 8C9.433 8 11 6.433 11 4.5C11 2.567 9.433 1 7.5 1Z"/>
                    </svg>
                </button>
            </div>

            <!-- Filter button -->
            <button class="header-filter-btn" id="filterBtn" title="Search options">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                    <line x1="2" y1="4" x2="14" y2="4"/>
                    <line x1="2" y1="8" x2="14" y2="8"/>
                    <line x1="2" y1="12" x2="14" y2="12"/>
                    <circle cx="5" cy="4" r="1.5" fill="currentColor" stroke="none"/>
                    <circle cx="10" cy="8" r="1.5" fill="currentColor" stroke="none"/>
                    <circle cx="7" cy="12" r="1.5" fill="currentColor" stroke="none"/>
                </svg>
                <svg class="filter-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 5l3 3 3-3"/>
                </svg>
            </button>

            <!-- Search Options Dropdown Panel -->
            <div class="search-options-panel" id="searchOptionsPanel">
                <div class="search-options-panel-title">Search Configuration</div>
                <div class="search-option-row">
                    <span class="search-option-label">Vector DB</span>
                    <select class="backend-dropdown" id="backendDropdown" title="Choose vector database backend">
                        <option value="s3vectors">S3 Vectors</option>
                        <option value="mongodb">MongoDB</option>
                    </select>
                </div>
                <div class="search-option-row">
                    <span class="search-option-label">Index Mode</span>
                    <div class="search-option-right">
                        <span class="index-mode-indicator" id="indexModeIndicator">Multi-Index</span>
                        <label class="toggle-switch" title="Toggle between Unified-Index and Multi-Index">
                            <input type="checkbox" id="indexModeToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header right: Upload, Theme toggle, User avatar -->
        <div class="header-right">
            <button class="header-icon-btn" id="themeToggle" title="Toggle theme">
                <svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <button class="header-avatar-btn" id="userAvatarBtn" title="User profile">
                <svg width="16" height="16" viewBox="0 0 13 11.3333" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M6.50065 4.33333C7.42113 4.33333 8.16732 3.58714 8.16732 2.66667C8.16732 1.74619 7.42113 1 6.50065 1C5.58018 1 4.83398 1.74619 4.83398 2.66667C4.83398 3.58714 5.58018 4.33333 6.50065 4.33333ZM6.50065 5.33333C7.97341 5.33333 9.16732 4.13943 9.16732 2.66667C9.16732 1.19391 7.97341 0 6.50065 0C5.02789 0 3.83398 1.19391 3.83398 2.66667C3.83398 4.13943 5.02789 5.33333 6.50065 5.33333Z"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0 9.33331C0 7.58441 1.41777 6.16665 3.16667 6.16665H9.83333C11.5822 6.16665 13 7.58441 13 9.33331V11.3333H12V9.33331C12 8.1367 11.03 7.16665 9.83333 7.16665H3.16667C1.97005 7.16665 1 8.1367 1 9.33331V11.3333H0V9.33331Z"/>
                </svg>
            </button>
        </div>
        </div><!-- /header-top -->

        <!-- Category pills (search modes) + LLM decomposition toggle -->
        <div class="category-pills-row">
            <div class="category-pills-center">
                <div class="category-pills" id="categoryPills">
                    <button class="category-pill" data-mode="fused" title="Simple fusion with fixed default weights (visual=0.8, audio=0.1, transcription=0.05)">Fused</button>
                    <button class="category-pill" data-mode="rrf" title="Multi-vector fusion using Reciprocal Rank Fusion">RRF</button>
                    <button class="category-pill" data-mode="weighted" title="Multi-vector fusion with adjustable weighted score combination">Weighted</button>
                    <button class="category-pill active" data-mode="dynamic" title="Multi-vector fusion with dynamic intent routing">Dynamic</button>
                    <button class="category-pill" data-mode="visual" title="Search visual content only">Visual</button>
                    <button class="category-pill" data-mode="audio" title="Search audio/sound only">Audio</button>
                    <button class="category-pill" data-mode="transcription" title="Search speech/transcription only">Speech</button>
                </div>
                <div class="decomposition-inline-toggle" id="decompositionToggleContainer">
                    <span class="decomposition-label">LLM Decomposition</span>
                    <label class="toggle-switch" title="Use Claude Haiku to decompose queries per modality">
                        <input type="checkbox" id="decompositionToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="pills-row-spacer"></div>
        </div>
    </header>

    <!-- =============================================
         Main Content
         ============================================= -->
    <main>
        <div id="homeView">

        <!-- Fused mode: fixed weights info -->
        <div class="weights-panel active" id="fusedPanel">
            <div class="weights-panel-title">Fused Embeddings (Fixed Weights)</div>
            <div class="weight-row">
                <span class="weight-label">Visual</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 80%; height: 100%; background: var(--visual-fill);"></div>
                </div>
                <span class="weight-value">0.80</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Audio</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 10%; height: 100%; background: var(--audio-fill);"></div>
                </div>
                <span class="weight-value">0.10</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Transcription</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 5%; height: 100%; background: var(--transcription-fill);"></div>
                </div>
                <span class="weight-value">0.05</span>
            </div>
        </div>

        <!-- Weighted mode: manual sliders -->
        <div class="weights-panel" id="weightsPanel">
            <div class="weights-panel-title">Adjust Modality Weights</div>
            <div class="weight-row">
                <span class="weight-label">Visual</span>
                <input type="range" class="weight-slider" id="visualWeight" min="0" max="100" value="80">
                <span class="weight-value" id="visualValue">0.80</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Audio</span>
                <input type="range" class="weight-slider" id="audioWeight" min="0" max="100" value="10">
                <span class="weight-value" id="audioValue">0.10</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Transcription</span>
                <input type="range" class="weight-slider" id="transcriptionWeight" min="0" max="100" value="5">
                <span class="weight-value" id="transcriptionValue">0.05</span>
            </div>
        </div>

        <!-- Dynamic mode: auto-computed weights display -->
        <div class="dynamic-weights-panel" id="dynamicWeightsPanel">
            <div class="weights-panel-title">Auto-Computed Weights (based on query intent)</div>
            <div class="dynamic-weight-bar">
                <span class="dynamic-weight-label">Visual</span>
                <div class="dynamic-weight-bar-container">
                    <div class="dynamic-weight-bar-fill visual" id="dynamicVisualBar" style="width: 0%"></div>
                </div>
                <span class="dynamic-weight-value visual" id="dynamicVisualValue">-</span>
            </div>
            <div class="dynamic-weight-bar">
                <span class="dynamic-weight-label">Audio</span>
                <div class="dynamic-weight-bar-container">
                    <div class="dynamic-weight-bar-fill audio" id="dynamicAudioBar" style="width: 0%"></div>
                </div>
                <span class="dynamic-weight-value audio" id="dynamicAudioValue">-</span>
            </div>
            <div class="dynamic-weight-bar">
                <span class="dynamic-weight-label">Transcription</span>
                <div class="dynamic-weight-bar-container">
                    <div class="dynamic-weight-bar-fill transcription" id="dynamicTranscriptionBar" style="width: 0%"></div>
                </div>
                <span class="dynamic-weight-value transcription" id="dynamicTranscriptionValue">-</span>
            </div>
        </div>

        <!-- RRF mode info -->
        <div class="weights-panel" id="rrfPanel">
            <div class="weights-panel-title">Reciprocal Rank Fusion (RRF) — Equal Modality Ranking</div>
            <div class="weight-row">
                <span class="weight-label">Visual</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 33%; height: 100%; background: var(--visual-fill);"></div>
                </div>
                <span class="weight-value">1/3</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Audio</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 33%; height: 100%; background: var(--audio-fill);"></div>
                </div>
                <span class="weight-value">1/3</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Transcription</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 33%; height: 100%; background: var(--transcription-fill);"></div>
                </div>
                <span class="weight-value">1/3</span>
            </div>
        </div>

        <!-- Decomposed Queries Display -->
        <div class="decomposed-queries" id="decomposedQueriesDisplay">
            <div class="decomposed-queries-title">
                Original Query: <span id="originalQueryText"></span>
            </div>
            <div class="decomposed-query-item">
                <div class="decomposed-query-label">Visual Query:</div>
                <div class="decomposed-query-text" id="visualQueryText"></div>
            </div>
            <div class="decomposed-query-item">
                <div class="decomposed-query-label">Audio Query:</div>
                <div class="decomposed-query-text" id="audioQueryText"></div>
            </div>
            <div class="decomposed-query-item">
                <div class="decomposed-query-label">Transcription Query:</div>
                <div class="decomposed-query-text" id="transcriptionQueryText"></div>
            </div>
        </div>

        <div class="results-header">
            <div>
                <span class="query-display" id="queryDisplay"></span>
                <span class="results-count" id="resultsCount"></span>
            </div>
        </div>

        <div id="resultsContainer">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <p>Enter a search query to find video segments</p>
            </div>
        </div>
        </div><!-- /homeView -->

        <!-- Analyze View — Search within Video -->
        <div id="analyzeView" class="analyze-view" style="display: none;">
            <!-- Left: Asset Selector + Chat History -->
            <div class="analyze-sidebar">
                <div class="analyze-sidebar-tabs">
                    <button class="analyze-sidebar-tab active" data-tab="history" id="tabHistory">History</button>
                    <button class="analyze-sidebar-tab" data-tab="assets" id="tabAssets">Assets</button>
                </div>
                <div class="analyze-asset-list" id="analyzeAssetList" style="display: none;">
                    <!-- Populated by JS: folders or video list -->
                </div>
                <div class="chat-history-list visible" id="chatHistoryList">
                    <button class="chat-history-new-btn" id="newChatBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        New Chat
                    </button>
                    <!-- Populated by renderConversationList() -->
                </div>
            </div>

            <!-- Right: Prompt + Results -->
            <div class="analyze-main">
                <!-- Selected video preview (shown when a video is selected) -->
                <div class="analyze-preview" id="analyzePreview" style="display: none;">
                    <video class="analyze-preview-video" id="analyzePreviewVideo" muted preload="metadata"></video>
                    <div class="analyze-preview-info">
                        <div class="analyze-preview-name" id="analyzePreviewName"></div>
                        <div class="analyze-preview-meta" id="analyzePreviewMeta"></div>
                    </div>
                    <button class="analyze-preview-clear" id="analyzeClearVideo" title="Clear selection">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Chat container -->
                <div class="analyze-chat-container" id="analyzeChatContainer">
                    <div class="analyze-chat-empty" id="analyzeChatEmpty">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity: 0.15;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>Chat with your assets, or select from the asset menu</p>
                    </div>
                </div>

                <!-- Quoted segments bar (visible when quoting results) -->
                <div class="chat-quoted-bar" id="chatQuotedBar">
                    <div class="chat-quoted-list" id="chatQuotedList">
                        <!-- Filled dynamically by quoteSegment() -->
                    </div>
                    <button class="chat-quoted-dismiss" id="chatQuotedDismiss" title="Clear selection">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Chat settings panel (collapsible) -->
                <div class="chat-settings-panel" id="chatSettingsPanel">
                    <div class="chat-settings-title">Search Configuration</div>
                    <div class="chat-settings-row">
                        <span class="chat-settings-label">Search Mode</span>
                        <div class="chat-mode-pills" id="chatModePills">
                            <button class="chat-mode-pill" data-mode="fused" title="Fixed default weights">Fused</button>
                            <button class="chat-mode-pill" data-mode="rrf" title="Reciprocal Rank Fusion">RRF</button>
                            <button class="chat-mode-pill" data-mode="weighted" title="Adjustable weighted score">Weighted</button>
                            <button class="chat-mode-pill active" data-mode="dynamic" title="Dynamic intent routing">Dynamic</button>
                            <button class="chat-mode-pill" data-mode="visual" title="Visual only">Visual</button>
                            <button class="chat-mode-pill" data-mode="audio" title="Audio only">Audio</button>
                            <button class="chat-mode-pill" data-mode="transcription" title="Speech only">Speech</button>
                        </div>
                    </div>
                    <div class="chat-settings-row">
                        <span class="chat-settings-label">Vector DB</span>
                        <select class="chat-settings-select" id="chatBackendSelect">
                            <option value="s3vectors">S3 Vectors</option>
                            <option value="mongodb">MongoDB</option>
                        </select>
                    </div>
                    <div class="chat-settings-row">
                        <span class="chat-settings-label">Index Mode</span>
                        <div class="chat-settings-right">
                            <span class="chat-settings-indicator" id="chatIndexIndicator">Multi-Index</span>
                            <label class="toggle-switch" title="Toggle index mode">
                                <input type="checkbox" id="chatIndexToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="chat-settings-row">
                        <span class="chat-settings-label">LLM Decomposition</span>
                        <div class="chat-settings-right">
                            <label class="toggle-switch" title="Decompose queries per modality">
                                <input type="checkbox" id="chatDecompToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Prompt input -->
                <div class="analyze-input-area">
                    <button class="chat-settings-btn" id="chatSettingsBtn" title="Search settings">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                    <label for="chatImageUpload" class="chat-settings-btn" title="Image search" id="chatImageBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </label>
                    <input type="file" id="chatImageUpload" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">
                    <div class="chat-image-preview" id="chatImagePreview">
                        <img id="chatPreviewImg" alt="Query image">
                        <button id="chatRemoveImage" type="button" title="Remove image">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <input type="text" class="analyze-input" id="analyzeInput" placeholder="Chat with your assets...">
                    <button class="analyze-send-btn" id="analyzeSendBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>

                <!-- Model selector + session cost -->
                <div class="chat-model-selector" id="chatModelSelector">
                    <button class="chat-model-btn active" data-model="auto" title="Agent auto-routes between search and analysis">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                        </svg>
                        <span>Auto</span>
                    </button>
                    <button class="chat-model-btn" data-model="marengo" title="Marengo 3.0 — Direct multimodal search">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <span>Marengo 3.0</span>
                    </button>
                    <button class="chat-model-btn" data-model="pegasus" title="Pegasus 1.2 — Video analysis (requires selected video)">
                        <svg width="14" height="14" viewBox="0 0 12 12" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M5 0C7.76142 0 10 2.23858 10 5C10 6.01926 9.69399 6.9672 9.16888 7.7545L11.7071 10.2929C12.0976 10.6834 12.0976 11.3166 11.7071 11.7071C11.3166 12.0976 10.6834 12.0976 10.2929 11.7071L7.7545 9.16888C6.9672 9.69399 6.01926 10 5 10C2.23858 10 0 7.76142 0 5C0 2.23858 2.23858 0 5 0ZM5 1C2.79086 1 1 2.79086 1 5C1 7.20914 2.79086 9 5 9C7.20914 9 9 7.20914 9 5C9 2.79086 7.20914 1 5 1ZM3.5 4C3.77614 4 4 4.22386 4 4.5V7C4 7.27614 3.77614 7.5 3.5 7.5C3.22386 7.5 3 7.27614 3 7V4.5C3 4.22386 3.22386 4 3.5 4ZM5 3C5.27614 3 5.5 3.22386 5.5 3.5V7C5.5 7.27614 5.27614 7.5 5 7.5C4.72386 7.5 4.5 7.27614 4.5 7V3.5C4.5 3.22386 4.72386 3 5 3ZM6.5 5C6.77614 5 7 5.22386 7 5.5V7C7 7.27614 6.77614 7.5 6.5 7.5C6.22386 7.5 6 7.27614 6 7V5.5C6 5.22386 6.22386 5 6.5 5Z"/>
                        </svg>
                        <span>Pegasus 1.2</span>
                    </button>
                    <div class="chat-session-cost" id="chatSessionCost" title="Estimated session cost">
                        <span class="chat-cost-label">Cost</span>
                        <span class="chat-cost-value" id="chatCostValue">$0.00</span>
                        <div class="chat-cost-breakdown" id="chatCostBreakdown">
                            <div class="chat-cost-breakdown-title">Session Breakdown</div>
                            <div id="chatCostRows"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Indexes View -->
        <div id="indexesView" style="display: none; padding: 24px 32px;">
            <!-- Breadcrumb -->
            <div class="indexes-breadcrumb" id="indexesBreadcrumb">
                <span class="indexes-breadcrumb-current">Indexes</span>
            </div>

            <!-- Folder Grid (default view) -->
            <div id="indexesListView">
                <div class="indexes-grid">
                    <div class="index-card" data-backend="mongodb" data-mode="unified">
                        <div class="index-card-icon no-thumbs" id="iconMongoUnified">
                            <svg width="20" height="20" viewBox="0 0 12 10" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                            </svg>
                        </div>
                        <div class="index-card-info">
                            <span class="index-card-name">MongoDB — Unified</span>
                            <span class="index-card-meta">Single-index, all modalities</span>
                            <span class="index-card-count" id="countMongoUnified">— videos</span>
                        </div>
                    </div>
                    <div class="index-card" data-backend="mongodb" data-mode="multi">
                        <div class="index-card-icon no-thumbs" id="iconMongoMulti">
                            <svg width="20" height="20" viewBox="0 0 12 10" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                            </svg>
                        </div>
                        <div class="index-card-info">
                            <span class="index-card-name">MongoDB — Multi</span>
                            <span class="index-card-meta">Per-modality indexes</span>
                            <span class="index-card-count" id="countMongoMulti">— videos</span>
                        </div>
                    </div>
                    <div class="index-card" data-backend="s3vectors" data-mode="unified">
                        <div class="index-card-icon no-thumbs" id="iconS3Unified">
                            <svg width="20" height="20" viewBox="0 0 12 10" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                            </svg>
                        </div>
                        <div class="index-card-info">
                            <span class="index-card-name">S3 Vectors — Unified</span>
                            <span class="index-card-meta">Single-index, all modalities</span>
                            <span class="index-card-count" id="countS3Unified">— videos</span>
                        </div>
                    </div>
                    <div class="index-card" data-backend="s3vectors" data-mode="multi">
                        <div class="index-card-icon no-thumbs" id="iconS3Multi">
                            <svg width="20" height="20" viewBox="0 0 12 10" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                            </svg>
                        </div>
                        <div class="index-card-info">
                            <span class="index-card-name">S3 Vectors — Multi</span>
                            <span class="index-card-meta">Per-modality indexes</span>
                            <span class="index-card-count" id="countS3Multi">— videos</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video List (shown when a folder is opened) -->
            <div id="indexesDetailView" style="display: none;">
                <div class="indexes-toolbar" id="indexesToolbar">
                    <button class="indexes-toolbar-btn" id="indexSelectToggle" title="Toggle multi-select mode">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        <span>Select</span>
                    </button>
                    <span class="indexes-toolbar-count" id="indexSelectCount" style="display:none;">0 selected</span>
                    <button class="indexes-toolbar-btn" id="indexSelectAll" style="display:none;">Select All</button>
                    <div class="indexes-toolbar-spacer"></div>
                    <button class="indexes-toolbar-btn danger" id="indexDeleteBtn" style="display:none;" disabled>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        <span>Delete</span>
                    </button>
                </div>
                <div class="indexes-video-grid" id="indexesVideoGrid"></div>
            </div>
        </div>
    </main>

    <!-- Video Modal -->
    <div class="modal" id="videoModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Video Playback</span>
                <div class="modal-header-actions">
                    <div class="modal-speed-control">
                        <button class="modal-speed-btn" data-speed="0.5">0.5x</button>
                        <button class="modal-speed-btn active" data-speed="1">1x</button>
                        <button class="modal-speed-btn" data-speed="1.5">1.5x</button>
                        <button class="modal-speed-btn" data-speed="2">2x</button>
                    </div>
                    <a class="modal-download-btn" id="modalDownloadBtn" download title="Download video">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </a>
                    <button class="modal-close" id="modalClose">&times;</button>
                </div>
            </div>
            <div class="video-container">
                <video id="videoPlayer" controls preload="auto"></video>
            </div>
            <div class="modal-info" id="modalInfo"></div>
        </div>
    </div>

    <!-- Code Inspection Modal -->
    <div class="code-inspection-modal" id="codeInspectionModal">
        <div class="code-modal-content">
            <div class="code-modal-header">
                <span class="code-modal-title">Search Code Inspection</span>
                <div class="code-modal-actions">
                    <button class="code-btn" id="copyCodeBtn">Copy JSON</button>
                    <button class="code-btn primary" id="exportCodeBtn">Export JSON</button>
                    <button class="code-modal-close" id="codeModalClose">&times;</button>
                </div>
            </div>
            <div class="code-tabs">
                <button class="code-tab active" data-tab="input">Input</button>
                <button class="code-tab" data-tab="output">Output</button>
            </div>
            <div class="code-content-area">
                <div class="code-panel active" id="inputPanel">
                    <pre class="code-block" id="inputCode"></pre>
                </div>
                <div class="code-panel" id="outputPanel">
                    <pre class="code-block" id="outputCode"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Show Code Button (floating) -->
    <button class="show-code-btn" id="showCodeBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="16 18 22 12 16 6"></polyline>
            <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        Show Code
    </button>

    <script>
        // =============================================
        // Theme Toggle
        // =============================================
        const themeToggle = document.getElementById('themeToggle');

        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('strand-dark-mode', String(next === 'dark'));
        });

        // Listen for system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (localStorage.getItem('strand-dark-mode') === null) {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        // =============================================
        // Sidebar Collapse/Expand
        // =============================================
        const sidebar = document.getElementById('sidebar');
        const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
        const headerMenuBtn = document.getElementById('headerMenuBtn');

        // Restore saved state
        if (localStorage.getItem('sidebar-collapsed') === 'true') {
            document.body.classList.add('sidebar-collapsed');
        }

        sidebarCollapseBtn.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
            localStorage.setItem('sidebar-collapsed', String(document.body.classList.contains('sidebar-collapsed')));
        });

        // Mobile sidebar toggle
        headerMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('sidebar-mobile-open');
        });

        // Close sidebar on outside click (mobile)
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(e.target) && !headerMenuBtn.contains(e.target)) {
                    sidebar.classList.remove('sidebar-mobile-open');
                }
            }
        });

        // =============================================
        // Filter Panel Toggle
        // =============================================
        const filterBtn = document.getElementById('filterBtn');
        const searchOptionsPanel = document.getElementById('searchOptionsPanel');

        filterBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            searchOptionsPanel.classList.toggle('open');
            filterBtn.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (!searchOptionsPanel.contains(e.target) && !filterBtn.contains(e.target)) {
                searchOptionsPanel.classList.remove('open');
                filterBtn.classList.remove('active');
            }
        });

        // =============================================
        // EXAMPLE QUERIES — Edit this array to change preset searches
        // =============================================
        const EXAMPLE_QUERIES = [
            'Ross says I take thee Rachel at a wedding',
            'Pennywise dancing in sewer saying we all float',
            'a player is executing a triple kill in league of legends',
            'Enthusiastic audience watching a tournament with powerful, emotional background music',
        ];
        let exampleQueryIndex = 0;

        // =============================================
        // State
        // =============================================
        let currentMode = 'dynamic';
        let currentResults = [];
        let preloadedVideoUrl = null;
        let lastDynamicWeights = null;
        let useDecomposition = true;
        let lastDecomposedQueries = null;

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const queryDisplay = document.getElementById('queryDisplay');
        const resultsCount = document.getElementById('resultsCount');
        const fusedPanel = document.getElementById('fusedPanel');
        const weightsPanel = document.getElementById('weightsPanel');
        const dynamicWeightsPanel = document.getElementById('dynamicWeightsPanel');
        const rrfPanel = document.getElementById('rrfPanel');
        const videoModal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('videoPlayer');
        const modalTitle = document.getElementById('modalTitle');
        const modalInfo = document.getElementById('modalInfo');
        const modalClose = document.getElementById('modalClose');
        const decompositionToggle = document.getElementById('decompositionToggle');
        const decompositionToggleContainer = document.getElementById('decompositionToggleContainer');
        const decomposedQueriesDisplay = document.getElementById('decomposedQueriesDisplay');

        // Multi-vector modes that use all modalities
        const MULTI_VECTOR_MODES = ['fused', 'rrf', 'weighted', 'dynamic'];

        // Modes that support LLM decomposition (excludes Fused and SINGLE modes)
        const DECOMPOSITION_MODES = ['rrf', 'weighted', 'dynamic'];

        // Image Upload Elements
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeImage = document.getElementById('removeImage');
        let currentImageBase64 = null;

        // Image Upload Handler
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                e.target.value = '';
                return;
            }

            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a JPEG, PNG, GIF, or WebP image');
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Data = event.target.result.split(',')[1];
                currentImageBase64 = base64Data;
                previewImg.src = event.target.result;
                imagePreview.classList.add('active');
                imagePreview.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        });

        // Remove Image Handler
        removeImage.addEventListener('click', function() {
            currentImageBase64 = null;
            imageUpload.value = '';
            imagePreview.classList.remove('active');
            imagePreview.style.display = 'none';
            previewImg.src = '';
        });

        // Update panel visibility based on mode
        function updatePanelVisibility() {
            fusedPanel.classList.toggle('active', currentMode === 'fused');
            weightsPanel.classList.toggle('active', currentMode === 'weighted');
            dynamicWeightsPanel.classList.toggle('active', currentMode === 'dynamic');
            rrfPanel.classList.toggle('active', currentMode === 'rrf');

            const supportsDecomposition = DECOMPOSITION_MODES.includes(currentMode);
            decompositionToggleContainer.style.opacity = supportsDecomposition ? '1' : '0.4';
            decompositionToggleContainer.style.pointerEvents = supportsDecomposition ? 'auto' : 'none';
            decompositionToggle.disabled = !supportsDecomposition;

            if (!supportsDecomposition) {
                decomposedQueriesDisplay.classList.remove('visible');
            }
        }

        // Update dynamic weights display
        function updateDynamicWeightsDisplay(weights) {
            if (!weights) return;
            lastDynamicWeights = weights;

            ['visual', 'audio', 'transcription'].forEach(modality => {
                const value = weights[modality] || 0;
                const percentage = (value * 100).toFixed(1);
                document.getElementById(`dynamic${capitalize(modality)}Bar`).style.width = `${percentage}%`;
                document.getElementById(`dynamic${capitalize(modality)}Value`).textContent = value.toFixed(3);
            });
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Display decomposed queries
        function displayDecomposedQueries(originalQuery, decomposedQueries) {
            if (!decomposedQueries) {
                decomposedQueriesDisplay.classList.remove('visible');
                return;
            }

            document.getElementById('originalQueryText').textContent = originalQuery;
            document.getElementById('visualQueryText').textContent = decomposedQueries.visual || originalQuery;
            document.getElementById('audioQueryText').textContent = decomposedQueries.audio || originalQuery;
            document.getElementById('transcriptionQueryText').textContent = decomposedQueries.transcription || originalQuery;
            decomposedQueriesDisplay.classList.add('visible');
            lastDecomposedQueries = decomposedQueries;
        }

        // Decomposition toggle event listener
        decompositionToggle.addEventListener('change', () => {
            useDecomposition = decompositionToggle.checked;

            if (!useDecomposition) {
                decomposedQueriesDisplay.classList.remove('visible');
            }

            if (searchInput.value.trim()) {
                performSearch();
            }
        });

        // All mode buttons (category pills)
        document.querySelectorAll('.category-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!btn.dataset.mode) return;

                document.querySelectorAll('.category-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;

                updatePanelVisibility();

                if (searchInput.value.trim()) {
                    performSearch();
                }
            });
        });

        // Weight sliders with debounced search
        let sliderDebounceTimer = null;
        ['visual', 'audio', 'transcription'].forEach(type => {
            const slider = document.getElementById(`${type}Weight`);
            const value = document.getElementById(`${type}Value`);

            slider.addEventListener('input', () => {
                value.textContent = (slider.value / 100).toFixed(2);

                clearTimeout(sliderDebounceTimer);
                sliderDebounceTimer = setTimeout(() => {
                    if (searchInput.value.trim() && currentMode === 'weighted') {
                        performSearch();
                    }
                }, 500);
            });
        });

        // Search
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        async function performSearch() {
            const query = searchInput.value.trim();

            if (!query && !currentImageBase64) {
                alert('Please enter a search query or upload an image');
                return;
            }

            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><span>Searching...</span></div>';

            if (query && currentImageBase64) {
                queryDisplay.textContent = `${query} + Image`;
            } else if (currentImageBase64) {
                queryDisplay.textContent = 'Image Search';
            } else {
                queryDisplay.textContent = query;
            }

            resultsCount.textContent = '';

            try {
                let results;
                let responseData = {};

                if (currentMode === 'dynamic') {
                    const request = {
                        query: query || '',
                        query_image: currentImageBase64,
                        limit: 20,
                        backend: selectedBackend,
                        use_multi_index: useMultiIndex,
                        use_decomposition: useDecomposition
                    };
                    const response = await fetch('/api/search/dynamic', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    });

                    if (!response.ok) throw new Error('Search failed');

                    responseData = await response.json();
                    results = responseData.results;
                    updateDynamicWeightsDisplay(responseData.computed_weights);

                    if (responseData.decomposed_queries) {
                        displayDecomposedQueries(query, responseData.decomposed_queries);
                    } else {
                        decomposedQueriesDisplay.classList.remove('visible');
                    }

                } else if (MULTI_VECTOR_MODES.includes(currentMode)) {
                    const request = {
                        query: query || '',
                        query_image: currentImageBase64,
                        limit: 20,
                        fusion_method: currentMode === 'rrf' ? 'rrf' : 'weighted',
                        backend: selectedBackend,
                        use_multi_index: useMultiIndex,
                        use_decomposition: DECOMPOSITION_MODES.includes(currentMode) && useDecomposition
                    };

                    if (currentMode === 'weighted') {
                        const visualW = document.getElementById('visualWeight').value / 100;
                        const audioW = document.getElementById('audioWeight').value / 100;
                        const transW = document.getElementById('transcriptionWeight').value / 100;

                        request.weights = {
                            visual: visualW,
                            audio: audioW,
                            transcription: transW
                        };
                    } else if (currentMode === 'fused') {
                        request.weights = {
                            visual: 0.8,
                            audio: 0.1,
                            transcription: 0.05
                        };
                    }

                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    });

                    if (!response.ok) throw new Error('Search failed');
                    responseData = await response.json();
                    results = responseData.results;

                    if (responseData.decomposed_queries) {
                        displayDecomposedQueries(query, responseData.decomposed_queries);
                    } else {
                        decomposedQueriesDisplay.classList.remove('visible');
                    }

                } else {
                    const request = {
                        query: query || '',
                        query_image: currentImageBase64,
                        limit: 20,
                        modalities: [currentMode],
                        fusion_method: 'weighted',
                        backend: selectedBackend,
                        use_multi_index: useMultiIndex
                    };

                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    });

                    if (!response.ok) throw new Error('Search failed');
                    responseData = await response.json();
                    results = responseData.results;

                    decomposedQueriesDisplay.classList.remove('visible');
                }

                currentResults = results || responseData.results;
                renderResults(results);

                storeSearchData(query, results, responseData);

                showCodeBtn.classList.add('visible');

                if (results.length > 0 && results[0].video_url) {
                    preloadedVideoUrl = results[0].video_url;
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>Search failed. Please try again.</p>
                    </div>
                `;
            }
        }

        // Store search data for code inspection
        function storeSearchData(query, results, responseData) {
            searchInputData = {
                mode: currentMode,
                query: query,
                backend: selectedBackend,
                use_multi_index: useMultiIndex,
                fusion_method: currentMode === 'rrf' ? 'rrf' : 'weighted',
                query_embeddings: responseData?.query_embeddings || null,
                decomposed_queries: responseData?.decomposed_queries || null,
                weights: {},
                parameters: {}
            };

            if (currentMode === 'fused') {
                searchInputData.weights = { visual: 0.8, audio: 0.1, transcription: 0.05 };
            } else if (currentMode === 'weighted') {
                searchInputData.weights = {
                    visual: parseFloat(document.getElementById('visualWeight').value) / 100,
                    audio: parseFloat(document.getElementById('audioWeight').value) / 100,
                    transcription: parseFloat(document.getElementById('transcriptionWeight').value) / 100
                };
            } else if (currentMode === 'dynamic') {
                searchInputData.weights = responseData?.computed_weights || lastDynamicWeights;
                searchInputData.anchor_similarities = responseData?.anchor_similarities;
                searchInputData.parameters.alpha = 10;
            } else if (currentMode === 'rrf') {
                searchInputData.parameters.k = 60;
            }

            searchInputData.parameters.top_k = 20;
            searchInputData.parameters.limit = 20;

            searchOutputData = {
                results: results.map(r => ({
                    segment_id: r.segment_id,
                    video_id: r.video_id,
                    start_time: r.start_time,
                    end_time: r.end_time,
                    s3_uri: r.s3_uri,
                    result_embeddings: r.embedding || null,
                    scores: {
                        ...r.modality_scores,
                        final: r.fusion_score
                    },
                    ranks: r.modality_ranks || null,
                    metadata: {
                        video_url: r.video_url,
                        thumbnail_url: r.thumbnail_url
                    }
                })),
                total_results: results.length,
                search_time_ms: responseData?.search_time_ms || null,
                backend: useMultiIndex ? 's3_vectors' : 'mongodb'
            };
        }

        function renderResults(results) {
            const modeLabel = getModeLabel(currentMode);
            resultsCount.textContent = `${results.length} results (${modeLabel})`;

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No results found for this query.</p>
                    </div>
                `;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'results-grid';

            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.onclick = () => openVideo(result);

                const startTime = formatTime(result.start_time);
                const endTime = formatTime(result.end_time);

                const filename = result.s3_uri.split('/').pop() || 'Video';

                const modalityScores = result.modality_scores || {};
                const modalityTags = Object.entries(modalityScores)
                    .map(([mod, score]) => `<span class="meta-tag ${mod}">${mod.substring(0, 3)}: ${score.toFixed(2)}</span>`)
                    .join('');

                let dominantModality = null;
                let maxScore = 0;
                for (const [mod, score] of Object.entries(modalityScores)) {
                    if (score > maxScore) {
                        maxScore = score;
                        dominantModality = mod;
                    }
                }

                const maxPossibleScore = Math.max(...Object.values(modalityScores), 0.001);
                const modalityBars = ['visual', 'audio', 'transcription'].map(mod => {
                    const score = modalityScores[mod] || 0;
                    const width = (score / maxPossibleScore * 100).toFixed(1);
                    return `<div class="modality-bar"><div class="modality-bar-fill ${mod}" style="width: ${width}%"></div></div>`;
                }).join('');

                const showDominant = MULTI_VECTOR_MODES.includes(currentMode) && dominantModality;
                const dominantIndicator = showDominant
                    ? `<span class="dominant-indicator ${dominantModality}">${dominantModality.substring(0, 3)}</span>`
                    : '';

                const rank = index + 1;
                const confidenceScore = result.confidence_score !== undefined ? result.confidence_score : result.fusion_score;
                const confidencePercent = Math.round(confidenceScore * 100);

                card.innerHTML = `
                    <div class="thumbnail-container">
                        <div class="thumbnail-placeholder" id="placeholder-${index}">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </div>
                        <video
                            class="thumbnail-video"
                            muted
                            preload="metadata"
                            data-start="${result.start_time}"
                            data-index="${index}"
                            crossorigin="anonymous"
                        >
                            <source src="${result.video_url}" type="video/mp4">
                        </video>
                        <div class="play-overlay">
                            <svg viewBox="0 0 24 24" fill="white">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </div>
                        <span class="rank-badge">#${rank}</span>
                        <span class="confidence-badge">
                            <span class="confidence-value">${confidencePercent}%</span>
                        </span>
                        ${dominantIndicator}
                        <span class="duration-badge">${startTime} - ${endTime}</span>
                    </div>
                    <div class="card-info">
                        <div class="card-title">${filename}</div>
                        <div class="card-subtitle">Segment ${result.segment_id} &middot; ${startTime} - ${endTime}</div>
                        <div class="card-meta">
                            ${modalityTags}
                        </div>
                        <div class="modality-bars">
                            ${modalityBars}
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });

            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(grid);

            initializeThumbnails();
        }

        function getModeLabel(mode) {
            const labels = {
                'fused': 'Fused Embeddings',
                'rrf': 'RRF Fusion',
                'weighted': 'Weighted Fusion',
                'dynamic': 'Dynamic Routing',
                'visual': 'Visual Only',
                'audio': 'Audio Only',
                'transcription': 'Speech Only'
            };
            return labels[mode] || mode;
        }

        function initializeThumbnails() {
            const videos = document.querySelectorAll('.thumbnail-video');

            videos.forEach(video => {
                const startTime = parseFloat(video.dataset.start);
                const index = video.dataset.index;
                const placeholder = document.getElementById(`placeholder-${index}`);

                video.addEventListener('loadedmetadata', () => {
                    video.currentTime = startTime;
                });

                video.addEventListener('seeked', () => {
                    if (placeholder) {
                        placeholder.classList.add('hidden');
                    }
                });

                video.addEventListener('error', () => {
                    console.log('Video thumbnail failed to load');
                });
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function openVideo(result) {
            if (!result.video_url) {
                alert('Video URL not available');
                return;
            }

            videoPlayer.src = result.video_url;
            videoPlayer.playbackRate = 1;
            document.querySelectorAll('.modal-speed-btn').forEach(b => b.classList.toggle('active', b.dataset.speed === '1'));
            const dlBtn = document.getElementById('modalDownloadBtn');
            dlBtn.href = result.video_url;
            dlBtn.download = (result.s3_uri ? result.s3_uri.split('/').pop() : 'video') + '.mp4';

            videoPlayer.addEventListener('loadedmetadata', function onLoaded() {
                videoPlayer.currentTime = result.start_time;
                videoPlayer.removeEventListener('loadedmetadata', onLoaded);
            });

            const filename = result.s3_uri.split('/').pop() || 'Video';
            modalTitle.textContent = `${filename} - ${formatTime(result.start_time)}`;

            const modalityScoresHtml = Object.entries(result.modality_scores || {})
                .map(([mod, score]) => `<span class="meta-tag ${mod}">${mod}: ${score.toFixed(4)}</span>`)
                .join('');

            const confidenceScore = result.confidence_score !== undefined ? result.confidence_score : result.fusion_score;
            const confidencePercent = Math.round(confidenceScore * 100);

            modalInfo.innerHTML = `
                <span class="meta-tag">Segment: ${result.segment_id}</span>
                <span class="meta-tag">Time: ${formatTime(result.start_time)} - ${formatTime(result.end_time)}</span>
                <span class="meta-tag">Confidence: ${confidencePercent}% (${confidenceScore.toFixed(4)})</span>
                <span class="meta-tag">Fusion: ${result.fusion_score.toFixed(4)}</span>
                ${modalityScoresHtml}
            `;

            videoModal.classList.add('active');
            videoPlayer.play().catch(e => console.log('Autoplay prevented:', e));
        }

        // Close modal
        modalClose.addEventListener('click', closeModal);
        videoModal.addEventListener('click', (e) => {
            if (e.target === videoModal) closeModal();
        });

        function closeModal() {
            videoModal.classList.remove('active');
            videoPlayer.pause();
            videoPlayer.src = '';
            videoPlayer.playbackRate = 1;
            document.querySelectorAll('.modal-speed-btn').forEach(b => b.classList.toggle('active', b.dataset.speed === '1'));
        }

        // Playback speed controls
        document.querySelectorAll('.modal-speed-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const speed = parseFloat(btn.dataset.speed);
                videoPlayer.playbackRate = speed;
                document.querySelectorAll('.modal-speed-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeCodeModal();
                searchOptionsPanel.classList.remove('open');
                filterBtn.classList.remove('active');
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('sidebar-mobile-open');
                }
            }
            if (e.key === '/' && document.activeElement !== searchInput) {
                e.preventDefault();
                searchInput.focus();
            }
        });

        // =============================================
        // Code Inspection Feature
        // =============================================
        let searchInputData = null;
        let searchOutputData = null;

        const codeInspectionModal = document.getElementById('codeInspectionModal');
        const showCodeBtn = document.getElementById('showCodeBtn');
        const codeModalClose = document.getElementById('codeModalClose');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const exportCodeBtn = document.getElementById('exportCodeBtn');
        const inputPanel = document.getElementById('inputPanel');
        const outputPanel = document.getElementById('outputPanel');
        const inputCode = document.getElementById('inputCode');
        const outputCode = document.getElementById('outputCode');

        // Tab switching
        document.querySelectorAll('.code-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.code-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(`${tabName}Panel`).classList.add('active');
            });
        });

        // Show code modal
        showCodeBtn.addEventListener('click', () => {
            if (searchInputData && searchOutputData) {
                displayCodeInspection();
                codeInspectionModal.classList.add('active');
            }
        });

        // Close code modal
        codeModalClose.addEventListener('click', closeCodeModal);
        codeInspectionModal.addEventListener('click', (e) => {
            if (e.target === codeInspectionModal) closeCodeModal();
        });

        function closeCodeModal() {
            codeInspectionModal.classList.remove('active');
        }

        // Copy JSON to clipboard
        copyCodeBtn.addEventListener('click', async () => {
            const activeTab = document.querySelector('.code-tab.active').dataset.tab;
            const jsonData = activeTab === 'input' ? searchInputData : searchOutputData;

            try {
                await navigator.clipboard.writeText(JSON.stringify(jsonData, null, 2));
                copyCodeBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyCodeBtn.textContent = 'Copy JSON';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        });

        // Export JSON file
        exportCodeBtn.addEventListener('click', () => {
            const combined = {
                input: searchInputData,
                output: searchOutputData,
                timestamp: new Date().toISOString(),
                mode: currentMode
            };

            const blob = new Blob([JSON.stringify(combined, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `search_results_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Format JSON with syntax highlighting
        function formatJSON(json) {
            const jsonStr = JSON.stringify(json, null, 2);
            return jsonStr
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (-?\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/: (null)/g, ': <span class="json-null">$1</span>');
        }

        // Display code inspection
        function displayCodeInspection() {
            inputCode.innerHTML = formatJSON(searchInputData);
            outputCode.innerHTML = formatJSON(searchOutputData);
        }

        // =============================================
        // Backend and Index Mode Controls
        // =============================================
        const backendDropdown = document.getElementById('backendDropdown');
        const indexModeToggle = document.getElementById('indexModeToggle');
        const indexModeIndicator = document.getElementById('indexModeIndicator');
        let selectedBackend = 's3vectors';
        let useMultiIndex = true;

        // Check backend availability on load
        async function checkBackendAvailability() {
            try {
                const response = await fetch('/api/index-mode');
                if (!response.ok) return;

                const data = await response.json();

                if (!data.s3_vectors_available) {
                    selectedBackend = 'mongodb';
                    backendDropdown.value = 'mongodb';
                    useMultiIndex = false;
                    indexModeToggle.checked = false;
                    indexModeToggle.disabled = false;
                    updateIndexModeIndicator();
                    console.log('S3 Vectors not available, defaulting to MongoDB (unified-index, toggle enabled)');
                } else {
                    selectedBackend = 's3vectors';
                    backendDropdown.value = 's3vectors';
                    useMultiIndex = true;
                    indexModeToggle.checked = true;
                    indexModeToggle.disabled = false;
                    updateIndexModeIndicator();
                    console.log('S3 Vectors available, defaulting to multi-index mode (toggle enabled)');
                }
            } catch (error) {
                console.log('Backend availability check failed:', error);
            }
        }

        // Handle backend dropdown change
        backendDropdown.addEventListener('change', () => {
            selectedBackend = backendDropdown.value;

            if (selectedBackend === 'mongodb') {
                useMultiIndex = false;
                indexModeToggle.checked = false;
                indexModeToggle.disabled = false;
                updateIndexModeIndicator();
            } else {
                useMultiIndex = true;
                indexModeToggle.checked = true;
                indexModeToggle.disabled = false;
                updateIndexModeIndicator();
            }

            if (searchInput.value.trim()) {
                performSearch();
            }
        });

        // Handle index mode toggle change
        indexModeToggle.addEventListener('change', () => {
            useMultiIndex = indexModeToggle.checked;
            updateIndexModeIndicator();

            if (searchInput.value.trim()) {
                performSearch();
            }
        });

        // Update index mode indicator text
        function updateIndexModeIndicator() {
            indexModeIndicator.textContent = useMultiIndex ? 'Multi-Index' : 'Unified-Index';
        }

        // Initialize on page load
        checkBackendAvailability();
        updatePanelVisibility(); // Disable decomposition toggle on initial load

        // =============================================
        // Sidebar Navigation — Page Switching
        // =============================================
        function switchToPage(page) {
            const homeView = document.getElementById('homeView');
            const analyzeView = document.getElementById('analyzeView');
            const indexesView = document.getElementById('indexesView');
            const pillsRow = document.querySelector('.category-pills-row');

            // Hide all views
            homeView.style.display = 'none';
            analyzeView.style.display = 'none';
            indexesView.style.display = 'none';

            // Show target view + control pills visibility
            // Hide Code button on non-Home pages
            if (page !== 'home') {
                document.getElementById('showCodeBtn').classList.remove('visible');
            }

            if (page === 'analyze') {
                analyzeView.style.display = 'flex';
                pillsRow.style.display = 'none';
                analyzeFolderState = 'folders';
                loadAnalyzeFolders();
                // Reset to History tab (default) and render conversation list
                document.querySelectorAll('.analyze-sidebar-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('tabHistory').classList.add('active');
                document.getElementById('analyzeAssetList').style.display = 'none';
                document.getElementById('chatHistoryList').classList.add('visible');
                renderConversationList();
            } else if (page === 'indexes') {
                indexesView.style.display = 'block';
                pillsRow.style.display = 'none';
                // Always reset to root folder view
                document.getElementById('indexesListView').style.display = 'block';
                document.getElementById('indexesDetailView').style.display = 'none';
                document.getElementById('indexesBreadcrumb').innerHTML =
                    '<span class="indexes-breadcrumb-current">Indexes</span>';
                loadIndexCounts();
            } else {
                homeView.style.display = 'block';
                pillsRow.style.display = 'flex';
            }

            // Update sidebar active state
            document.querySelectorAll('.sidebar-nav-item[data-page]').forEach(i => i.classList.remove('active'));
            const target = document.querySelector(`.sidebar-nav-item[data-page="${page}"]`);
            if (target) target.classList.add('active');
        }

        document.querySelectorAll('.sidebar-nav-item[data-page]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const page = item.dataset.page;

                switchToPage(page);

                // Home — clear search and reset
                if (page === 'home') {
                    searchInput.value = '';
                    resultsContainer.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg><p>Enter a search query to find video segments</p></div>';
                    queryDisplay.textContent = '';
                    resultsCount.textContent = '';
                    currentResults = [];
                    decomposedQueriesDisplay.classList.remove('visible');
                    // Reset dynamic weight bars
                    lastDynamicWeights = null;
                    ['visual', 'audio', 'transcription'].forEach(m => {
                        document.getElementById(`dynamic${capitalize(m)}Bar`).style.width = '0%';
                        document.getElementById(`dynamic${capitalize(m)}Value`).textContent = '-';
                    });
                    // Clear image attachment
                    currentImageBase64 = null;
                    imageUpload.value = '';
                    imagePreview.classList.remove('active');
                    imagePreview.style.display = 'none';
                    previewImg.src = '';
                }

                // Examples — cycle through preset queries and search
                if (page === 'examples') {
                    // Clear image attachment before running example
                    currentImageBase64 = null;
                    imageUpload.value = '';
                    imagePreview.classList.remove('active');
                    imagePreview.style.display = 'none';
                    previewImg.src = '';
                    decomposedQueriesDisplay.classList.remove('visible');
                    const query = EXAMPLE_QUERIES[exampleQueryIndex];
                    exampleQueryIndex = (exampleQueryIndex + 1) % EXAMPLE_QUERIES.length;
                    searchInput.value = query;
                    performSearch();
                }
            });
        });

        // =============================================
        // Indexes Page
        // =============================================
        let indexCountsLoaded = false;
        let indexSelectMode = false;
        let currentIndexBackend = null;
        let currentIndexMode = null;
        let currentIndexVideos = [];

        async function loadIndexCounts() {
            if (indexCountsLoaded) return;
            indexCountsLoaded = true;

            const combos = [
                { backend: 'mongodb', mode: 'unified', countEl: 'countMongoUnified', iconEl: 'iconMongoUnified' },
                { backend: 'mongodb', mode: 'multi', countEl: 'countMongoMulti', iconEl: 'iconMongoMulti' },
                { backend: 's3vectors', mode: 'unified', countEl: 'countS3Unified', iconEl: 'iconS3Unified' },
                { backend: 's3vectors', mode: 'multi', countEl: 'countS3Multi', iconEl: 'iconS3Multi' },
            ];
            for (const c of combos) {
                fetch(`/api/indexes/${c.backend}/${c.mode}/videos`)
                    .then(r => r.json())
                    .then(videos => {
                        document.getElementById(c.countEl).textContent = `${videos.length} videos`;
                        // Pick 4 random videos for thumbnail grid (never the same order)
                        const withUrls = videos.filter(v => v.video_url);
                        if (withUrls.length >= 2) {
                            const shuffled = withUrls.sort(() => Math.random() - 0.5);
                            const picks = shuffled.slice(0, 4);
                            const iconEl = document.getElementById(c.iconEl);
                            iconEl.classList.remove('no-thumbs');
                            iconEl.innerHTML = picks.map(v =>
                                `<video class="index-card-thumb" src="${v.video_url}" muted preload="metadata"></video>`
                            ).join('') + (picks.length < 4 ? '<div class="index-card-thumb-placeholder"></div>'.repeat(4 - picks.length) : '');
                            // Seek each thumb to a random frame
                            iconEl.querySelectorAll('video.index-card-thumb').forEach(thumb => {
                                thumb.addEventListener('loadedmetadata', () => {
                                    if (thumb.duration > 0) {
                                        thumb.currentTime = thumb.duration * (0.1 + Math.random() * 0.7);
                                    }
                                });
                            });
                        }
                    })
                    .catch(() => {
                        document.getElementById(c.countEl).textContent = 'unavailable';
                    });
            }
        }

        // Open folder → video list
        document.querySelectorAll('.index-card').forEach(card => {
            card.addEventListener('click', () => {
                const backend = card.dataset.backend;
                const mode = card.dataset.mode;
                openIndex(backend, mode);
            });
        });

        function openIndex(backend, mode) {
            currentIndexBackend = backend;
            currentIndexMode = mode;
            exitIndexSelectMode();
            document.getElementById('indexesListView').style.display = 'none';
            document.getElementById('indexesDetailView').style.display = 'block';
            updateIndexBreadcrumb(backend, mode);

            const grid = document.getElementById('indexesVideoGrid');
            grid.innerHTML = '<div style="color: var(--text-tertiary); padding: 20px;">Loading videos...</div>';

            fetch(`/api/indexes/${backend}/${mode}/videos`)
                .then(r => r.json())
                .then(videos => {
                    currentIndexVideos = videos;
                    renderIndexVideos(videos);
                })
                .catch(() => {
                    grid.innerHTML = '<div style="color: var(--text-tertiary); padding: 20px;">Failed to load videos.</div>';
                });
        }

        function renderIndexVideos(videos) {
            const grid = document.getElementById('indexesVideoGrid');
            if (!videos.length) {
                grid.innerHTML = '<div style="color: var(--text-tertiary); padding: 20px;">No videos in this index.</div>';
                return;
            }
            grid.innerHTML = videos.map((v, i) => {
                const displayName = v.name || v.video_id;
                return `
                <div class="index-video-card" data-video-url="${v.video_url || ''}" data-name="${escapeHtml(displayName)}" data-video-id="${v.video_id || ''}" data-idx="${i}">
                    <div class="index-video-thumb-wrap">
                        <video class="index-video-thumb" src="${v.video_url || ''}" muted preload="metadata"></video>
                        <div class="index-video-check">&#10003;</div>
                    </div>
                    <div class="index-video-info">
                        <div class="index-video-name" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}</div>
                        <div class="index-video-segments">${v.segment_count || 0} segments</div>
                    </div>
                </div>
            `}).join('');

            grid.querySelectorAll('.index-video-card').forEach(card => {
                const thumb = card.querySelector('.index-video-thumb');
                thumb.addEventListener('loadedmetadata', () => {
                    if (thumb.duration && thumb.duration > 0) {
                        const minT = thumb.duration * 0.1;
                        const maxT = thumb.duration * 0.8;
                        thumb.currentTime = minT + Math.random() * (maxT - minT);
                    }
                });
                card.addEventListener('click', () => {
                    if (indexSelectMode) {
                        card.classList.toggle('selected');
                        updateIndexSelectCount();
                    } else {
                        openVideoModal(card.dataset.videoUrl, card.dataset.name);
                    }
                });
            });
        }

        function openVideoModal(url, title, resultData) {
            const player = document.getElementById('videoPlayer');
            const modal = document.getElementById('videoModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalInfo = document.getElementById('modalInfo');
            player.src = url;
            player.playbackRate = 1;
            document.querySelectorAll('.modal-speed-btn').forEach(b => b.classList.toggle('active', b.dataset.speed === '1'));
            // Set download link (strip #t= fragment for clean download)
            const dlBtn = document.getElementById('modalDownloadBtn');
            const cleanUrl = url.split('#')[0];
            dlBtn.href = cleanUrl;
            dlBtn.download = (title || 'video') + '.mp4';
            modalTitle.textContent = title || 'Video Playback';

            // Show modality scores + segment info if result data provided
            if (resultData && resultData.modality_scores && Object.keys(resultData.modality_scores).length) {
                const scores = resultData.modality_scores;
                const modalityHtml = Object.entries(scores)
                    .map(([mod, score]) => `<span class="meta-tag ${mod}">${mod}: ${(score * 100).toFixed(1)}%</span>`)
                    .join('');
                const confidence = resultData.confidence_score !== undefined
                    ? resultData.confidence_score
                    : (resultData.fusion_score || resultData.score || 0);
                const confidencePct = Math.round(confidence * 100);

                let infoHtml = '';
                if (resultData.segment_id !== undefined) {
                    infoHtml += `<span class="meta-tag">Seg ${resultData.segment_id}</span>`;
                }
                if (resultData.start_time !== undefined) {
                    infoHtml += `<span class="meta-tag">${formatTime(resultData.start_time)} - ${formatTime(resultData.end_time || 0)}</span>`;
                }
                infoHtml += `<span class="meta-tag">Confidence: ${confidencePct}%</span>`;
                infoHtml += modalityHtml;
                modalInfo.innerHTML = infoHtml;
            } else {
                modalInfo.innerHTML = '';
            }

            modal.classList.add('active');
            player.play();
        }

        function updateIndexBreadcrumb(backend, mode) {
            const label = backend === 'mongodb'
                ? `MongoDB — ${mode === 'unified' ? 'Unified' : 'Multi'}`
                : `S3 Vectors — ${mode === 'unified' ? 'Unified' : 'Multi'}`;
            document.getElementById('indexesBreadcrumb').innerHTML = `
                <span class="indexes-breadcrumb-link" onclick="closeIndexDetail()">Indexes</span>
                <span class="indexes-breadcrumb-separator">&rsaquo;</span>
                <span class="indexes-breadcrumb-current">${label}</span>
            `;
        }

        function closeIndexDetail() {
            exitIndexSelectMode();
            document.getElementById('indexesListView').style.display = 'block';
            document.getElementById('indexesDetailView').style.display = 'none';
            document.getElementById('indexesBreadcrumb').innerHTML =
                '<span class="indexes-breadcrumb-current">Indexes</span>';
        }

        // --- Multi-select & Delete ---
        document.getElementById('indexSelectToggle').addEventListener('click', () => {
            if (indexSelectMode) {
                exitIndexSelectMode();
            } else {
                enterIndexSelectMode();
            }
        });

        function enterIndexSelectMode() {
            indexSelectMode = true;
            document.getElementById('indexSelectToggle').classList.add('active');
            document.getElementById('indexSelectToggle').querySelector('span').textContent = 'Cancel';
            document.getElementById('indexSelectCount').style.display = '';
            document.getElementById('indexSelectAll').style.display = '';
            document.getElementById('indexDeleteBtn').style.display = '';
            updateIndexSelectCount();
        }

        function exitIndexSelectMode() {
            indexSelectMode = false;
            document.getElementById('indexSelectToggle').classList.remove('active');
            document.getElementById('indexSelectToggle').querySelector('span').textContent = 'Select';
            document.getElementById('indexSelectCount').style.display = 'none';
            document.getElementById('indexSelectAll').style.display = 'none';
            document.getElementById('indexDeleteBtn').style.display = 'none';
            document.querySelectorAll('.index-video-card.selected').forEach(c => c.classList.remove('selected'));
        }

        function updateIndexSelectCount() {
            const count = document.querySelectorAll('.index-video-card.selected').length;
            document.getElementById('indexSelectCount').textContent = `${count} selected`;
            document.getElementById('indexDeleteBtn').disabled = count === 0;
        }

        document.getElementById('indexSelectAll').addEventListener('click', () => {
            const cards = document.querySelectorAll('.index-video-card');
            const allSelected = document.querySelectorAll('.index-video-card.selected').length === cards.length;
            cards.forEach(c => {
                if (allSelected) c.classList.remove('selected');
                else c.classList.add('selected');
            });
            document.getElementById('indexSelectAll').textContent = allSelected ? 'Select All' : 'Deselect All';
            updateIndexSelectCount();
        });

        document.getElementById('indexDeleteBtn').addEventListener('click', () => {
            const selected = document.querySelectorAll('.index-video-card.selected');
            if (!selected.length) return;

            const videoIds = Array.from(selected).map(c => c.dataset.videoId);
            const names = Array.from(selected).map(c => c.dataset.name);

            // Show confirmation
            const overlay = document.createElement('div');
            overlay.className = 'confirm-overlay';
            overlay.innerHTML = `
                <div class="confirm-box">
                    <h3>Delete ${videoIds.length} video${videoIds.length > 1 ? 's' : ''}?</h3>
                    <p>This will permanently delete all embeddings from <strong>all backends</strong> (S3 Vectors + MongoDB) and remove the proxy file from S3.<br><br>
                    ${names.slice(0, 5).map(n => `&bull; ${n}`).join('<br>')}
                    ${names.length > 5 ? `<br>&bull; ... and ${names.length - 5} more` : ''}</p>
                    <div class="confirm-actions">
                        <button class="confirm-btn" id="confirmCancel">Cancel</button>
                        <button class="confirm-btn danger" id="confirmDelete">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            overlay.querySelector('#confirmCancel').addEventListener('click', () => overlay.remove());
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });

            overlay.querySelector('#confirmDelete').addEventListener('click', async () => {
                const deleteBtn = overlay.querySelector('#confirmDelete');
                deleteBtn.textContent = 'Deleting...';
                deleteBtn.disabled = true;

                try {
                    const resp = await fetch('/api/videos/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ video_ids: videoIds })
                    });
                    const data = await resp.json();
                    overlay.remove();
                    exitIndexSelectMode();

                    // Refresh the index view
                    indexCountsLoaded = false;
                    loadIndexCounts();
                    if (currentIndexBackend && currentIndexMode) {
                        openIndex(currentIndexBackend, currentIndexMode);
                    }
                } catch (err) {
                    deleteBtn.textContent = 'Failed — retry?';
                    deleteBtn.disabled = false;
                    console.error('Delete failed:', err);
                }
            });
        });

        // =============================================
        // Analyze Page
        // =============================================
        let analyzeSelectedVideo = null;
        let analyzeFolderState = 'folders';
        let analyzeCurrentBackend = null;
        let analyzeCurrentMode = null;

        const ANALYZE_FOLDERS = [
            { backend: 's3vectors', mode: 'multi', name: 'S3 Vectors — Multi', meta: 'Multi-index, per modality' },
            { backend: 's3vectors', mode: 'unified', name: 'S3 Vectors — Unified', meta: 'Single-index, all modalities' },
            { backend: 'mongodb', mode: 'multi', name: 'MongoDB — Multi', meta: 'Multi-index, per modality' },
            { backend: 'mongodb', mode: 'unified', name: 'MongoDB — Unified', meta: 'Single-index, all modalities' },
        ];

        function loadAnalyzeFolders() {
            if (analyzeFolderState === 'videos') return; // Already viewing videos
            analyzeFolderState = 'folders';
            const list = document.getElementById('analyzeAssetList');
            list.innerHTML = ANALYZE_FOLDERS.map(f => `
                <div class="analyze-folder-item" data-backend="${f.backend}" data-mode="${f.mode}">
                    <div class="analyze-folder-icon">
                        <svg width="16" height="16" viewBox="0 0 12 10" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                        </svg>
                    </div>
                    <div class="analyze-folder-info">
                        <span class="analyze-folder-name">${f.name}</span>
                        <span class="analyze-folder-count">loading...</span>
                    </div>
                </div>
            `).join('');

            // Fetch counts
            list.querySelectorAll('.analyze-folder-item').forEach(item => {
                const backend = item.dataset.backend;
                const mode = item.dataset.mode;
                fetch(`/api/indexes/${backend}/${mode}/videos`)
                    .then(r => r.json())
                    .then(videos => {
                        item.querySelector('.analyze-folder-count').textContent = `${videos.length} videos`;
                    })
                    .catch(() => {
                        item.querySelector('.analyze-folder-count').textContent = 'unavailable';
                    });

                item.addEventListener('click', () => openAnalyzeFolder(backend, mode));
            });
        }

        function openAnalyzeFolder(backend, mode) {
            analyzeFolderState = 'videos';
            analyzeCurrentBackend = backend;
            analyzeCurrentMode = mode;

            const folderName = ANALYZE_FOLDERS.find(f => f.backend === backend && f.mode === mode)?.name || 'Index';
            // Tab title is set by the tab itself; no separate title element needed

            const list = document.getElementById('analyzeAssetList');
            list.innerHTML = '<div style="color: var(--text-tertiary); padding: 12px;">Loading...</div>';

            fetch(`/api/indexes/${backend}/${mode}/videos`)
                .then(r => r.json())
                .then(videos => {
                    list.innerHTML = `
                        <div class="analyze-back-btn" id="analyzeBackBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            All Indexes
                        </div>
                    ` + videos.map(v => {
                        const name = v.name || v.video_id;
                        return `
                        <div class="analyze-video-item" data-video-id="${v.video_id}" data-video-url="${v.video_url || ''}" data-s3-uri="${v.s3_uri || ''}" data-name="${name}" data-segments="${v.segment_count || 0}">
                            <video class="analyze-video-thumb" src="${v.video_url || ''}" muted preload="metadata"></video>
                            <span class="analyze-video-name" title="${name}">${name}</span>
                        </div>`;
                    }).join('');

                    // Back button
                    document.getElementById('analyzeBackBtn').addEventListener('click', () => {
                        analyzeFolderState = 'folders';
                        loadAnalyzeFolders();
                    });

                    // Video thumbnails: seek to random frame
                    list.querySelectorAll('.analyze-video-thumb').forEach(thumb => {
                        thumb.addEventListener('loadedmetadata', () => {
                            if (thumb.duration > 0) {
                                thumb.currentTime = thumb.duration * (0.1 + Math.random() * 0.7);
                            }
                        });
                    });

                    // Video selection (toggle — supports multi-select)
                    list.querySelectorAll('.analyze-video-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const isActive = item.classList.contains('active');
                            if (isActive) {
                                // Deselect this video
                                item.classList.remove('active');
                                if (analyzeSelectedVideo && analyzeSelectedVideo.video_id === item.dataset.videoId) {
                                    // Pick next active item as primary, or clear
                                    const nextActive = list.querySelector('.analyze-video-item.active');
                                    if (nextActive) {
                                        selectAnalyzeVideo({
                                            video_id: nextActive.dataset.videoId,
                                            video_url: nextActive.dataset.videoUrl,
                                            s3_uri: nextActive.dataset.s3Uri,
                                            name: nextActive.dataset.name,
                                            segment_count: nextActive.dataset.segments
                                        });
                                    } else {
                                        clearAnalyzeVideo();
                                    }
                                }
                            } else {
                                // Select this video (add to multi-select)
                                item.classList.add('active');
                                selectAnalyzeVideo({
                                    video_id: item.dataset.videoId,
                                    video_url: item.dataset.videoUrl,
                                    s3_uri: item.dataset.s3Uri,
                                    name: item.dataset.name,
                                    segment_count: item.dataset.segments
                                });
                            }
                        });
                    });
                })
                .catch(() => {
                    list.innerHTML = '<div style="color: var(--text-tertiary); padding: 12px;">Failed to load videos.</div>';
                });
        }

        function getSelectedVideos() {
            /** Collect all active videos from the sidebar. */
            const items = document.querySelectorAll('.analyze-video-item.active');
            return Array.from(items).map(item => ({
                video_id: item.dataset.videoId,
                video_url: item.dataset.videoUrl,
                s3_uri: item.dataset.s3Uri,
                name: item.dataset.name,
                segment_count: item.dataset.segments
            }));
        }

        function selectAnalyzeVideo(video) {
            analyzeSelectedVideo = video;
            const allSelected = getSelectedVideos();

            // Show preview bar
            const previewEl = document.getElementById('analyzePreview');
            previewEl.style.display = 'flex';

            const previewVideo = document.getElementById('analyzePreviewVideo');
            previewVideo.src = video.video_url;
            previewVideo.addEventListener('loadedmetadata', () => {
                if (previewVideo.duration > 0) {
                    previewVideo.currentTime = previewVideo.duration * 0.3;
                }
            }, { once: true });

            if (allSelected.length > 1) {
                document.getElementById('analyzePreviewName').textContent = `${allSelected.length} videos selected`;
                document.getElementById('analyzePreviewMeta').textContent = allSelected.map(v => v.name).join(', ');
                document.getElementById('analyzeInput').placeholder = `Chat with ${allSelected.length} videos...`;
            } else {
                document.getElementById('analyzePreviewName').textContent = video.name;
                document.getElementById('analyzePreviewMeta').textContent = `${video.segment_count} segments`;
                document.getElementById('analyzeInput').placeholder = `Chat with ${video.name}...`;
            }

            document.getElementById('analyzeInput').focus();
        }

        function clearAnalyzeVideo() {
            analyzeSelectedVideo = null;

            // Hide preview bar
            document.getElementById('analyzePreview').style.display = 'none';

            // Remove active state from sidebar
            document.querySelectorAll('.analyze-video-item.active').forEach(a => a.classList.remove('active'));

            // Reset placeholder (don't clear chat — keep conversation)
            document.getElementById('analyzeInput').placeholder = 'Chat with your assets...';
        }

        // ── Chat state ──
        let chatQuotedSegments = [];
        let chatModelMode = 'auto'; // 'auto' | 'marengo' | 'pegasus'
        let chatImageBase64 = null;
        let chatHistory = [];
        let chatSettings = {
            fusion_method: 'dynamic',
            backend: 's3vectors',
            use_multi_index: true,
            use_decomposition: false
        };
        let sessionCost = 0;
        const sessionCostByService = {};
        const COST_SERVICE_COLORS = {
            'Marengo 3.0': '#3b82f6',
            'Pegasus 1.2': '#8b5cf6',
            'Claude Haiku': '#f59e0b',
            'AWS Lambda': '#10b981',
            'Marengo Search': '#3b82f6',
            'Pegasus Analysis': '#8b5cf6',
        };

        function addSessionCost(costs) {
            if (!costs || !costs.total) return;
            sessionCost += costs.total;
            // Accumulate per-service
            if (costs.breakdown) {
                for (const item of costs.breakdown) {
                    const label = item.label || item.tool;
                    sessionCostByService[label] = (sessionCostByService[label] || 0) + item.cost;
                }
            }
            const valEl = document.getElementById('chatCostValue');
            if (valEl) valEl.textContent = '$' + sessionCost.toFixed(3);
            renderCostBreakdown();
        }

        function resetSessionCost() {
            sessionCost = 0;
            Object.keys(sessionCostByService).forEach(k => delete sessionCostByService[k]);
            const valEl = document.getElementById('chatCostValue');
            if (valEl) valEl.textContent = '$0.00';
            renderCostBreakdown();
        }

        function renderCostBreakdown() {
            const rowsEl = document.getElementById('chatCostRows');
            if (!rowsEl) return;
            const entries = Object.entries(sessionCostByService).filter(([, v]) => v > 0);
            if (!entries.length) {
                rowsEl.innerHTML = '<div class="chat-cost-row" style="color:var(--text-tertiary)">No API calls yet</div>';
                return;
            }
            let html = '';
            for (const [label, cost] of entries) {
                const color = COST_SERVICE_COLORS[label] || '#6b7280';
                html += `<div class="chat-cost-row">
                    <span class="cost-svc"><span class="cost-dot" style="background:${color}"></span>${label}</span>
                    <span class="cost-amt">$${cost.toFixed(4)}</span>
                </div>`;
            }
            html += `<div class="chat-cost-row total">
                <span>Total</span>
                <span class="cost-amt">$${sessionCost.toFixed(4)}</span>
            </div>`;
            rowsEl.innerHTML = html;
        }

        // Toggle cost breakdown popup
        document.addEventListener('click', (e) => {
            const costEl = document.getElementById('chatSessionCost');
            const breakdownEl = document.getElementById('chatCostBreakdown');
            if (!costEl || !breakdownEl) return;
            if (costEl.contains(e.target) && !breakdownEl.contains(e.target)) {
                breakdownEl.classList.toggle('open');
            } else if (!costEl.contains(e.target)) {
                breakdownEl.classList.remove('open');
            }
        });

        // ── Conversation management ──
        let conversations = JSON.parse(localStorage.getItem('chatConversations') || '[]');
        let currentConversationId = localStorage.getItem('currentConversationId') || null;

        function generateConvId() {
            return 'conv_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
        }

        function saveConversations() {
            localStorage.setItem('chatConversations', JSON.stringify(conversations));
            localStorage.setItem('currentConversationId', currentConversationId || '');
        }

        function stripResultForHistory(r) {
            return {
                video_id: r.video_id, segment_id: r.segment_id,
                start_time: r.start_time, end_time: r.end_time,
                confidence_score: r.confidence_score !== undefined ? r.confidence_score : r.fusion_score,
                video_url: r.video_url, s3_uri: r.s3_uri
            };
        }

        function stripAssetForHistory(r) {
            return {
                video_id: r.video_id, video_url: r.video_url, s3_uri: r.s3_uri,
                best_score: r.best_score, segment_count: r.segment_count,
                best_segment: r.best_segment ? {
                    start_time: r.best_segment.start_time, end_time: r.best_segment.end_time
                } : null
            };
        }

        function saveChatHistory() {
            if (!currentConversationId) {
                // Auto-create a conversation when first message is sent
                currentConversationId = generateConvId();
                conversations.unshift({
                    id: currentConversationId,
                    title: '',
                    updated: Date.now(),
                    messages: []
                });
            }
            const conv = conversations.find(c => c.id === currentConversationId);
            if (conv) {
                conv.messages = chatHistory.slice(-50);
                conv.updated = Date.now();
                // Title from first user message
                if (!conv.title) {
                    const firstUser = chatHistory.find(m => m.role === 'user');
                    conv.title = firstUser ? firstUser.content.slice(0, 60) : 'New Chat';
                }
            }
            saveConversations();
            renderConversationList();
        }

        function newConversation() {
            // Save current if non-empty
            if (chatHistory.length > 0 && currentConversationId) {
                saveChatHistory();
            }
            chatHistory = [];
            currentConversationId = null;
            clearChatUI();
            resetSessionCost();
            renderConversationList();
        }

        function loadConversation(id) {
            // Save current messages without updating timestamp (prevents reorder)
            if (chatHistory.length > 0 && currentConversationId) {
                const prev = conversations.find(c => c.id === currentConversationId);
                if (prev) {
                    prev.messages = chatHistory.slice(-50);
                }
            }
            const conv = conversations.find(c => c.id === id);
            if (!conv) return;
            currentConversationId = id;
            chatHistory = [...conv.messages];
            saveConversations();

            // Rebuild chat UI from history
            clearChatUI();
            if (chatHistory.length > 0) removeEmptyState();
            for (const msg of chatHistory) {
                if (msg.role === 'user') {
                    appendUserMessage(msg.content, msg.quoteRefs || null, true);
                } else if (msg.role === 'assistant') {
                    if (msg.actions && msg.actions.length) {
                        msg.actions.forEach(action => {
                            if (action.type === 'search_results') appendAssistantResults(action.results || []);
                            else if (action.type === 'asset_results') appendAssistantAssetResults(action.results || []);
                            else if (action.type === 'analysis_text') appendAssistantText(action.text || '', true);
                            else if (action.type === 'subclip' || action.type === 'concatenation') appendClipResult(action);
                            else if (action.type === 'error') appendAssistantError(action.message || '');
                        });
                        if (msg.content) appendAssistantText(msg.content, true);
                    } else {
                        appendAssistantText(msg.content, true);
                    }
                }
            }
            // Add retry button to the last assistant message
            const allMsgs = document.querySelectorAll('#analyzeChatContainer .chat-message.assistant');
            if (allMsgs.length) {
                const lastMsg = allMsgs[allMsgs.length - 1];
                let toolbar = lastMsg.querySelector('.msg-toolbar');
                if (!toolbar) {
                    toolbar = document.createElement('div');
                    toolbar.className = 'msg-toolbar';
                    lastMsg.appendChild(toolbar);
                }
                if (!toolbar.querySelector('[title="Retry"]')) {
                    const retryBtn = document.createElement('button');
                    retryBtn.title = 'Retry';
                    retryBtn.innerHTML = ICON_RETRY;
                    retryBtn.addEventListener('click', retryLastUserMessage);
                    toolbar.appendChild(retryBtn);
                }
            }
            scrollChatToBottom();
            renderConversationList();
        }

        function deleteConversation(id, event) {
            event.stopPropagation();
            conversations = conversations.filter(c => c.id !== id);
            if (currentConversationId === id) {
                chatHistory = [];
                currentConversationId = null;
                clearChatUI();
            }
            saveConversations();
            renderConversationList();
        }

        function renderConversationList() {
            const list = document.getElementById('chatHistoryList');
            // Keep the New Chat button, remove everything else
            const btn = document.getElementById('newChatBtn');
            list.innerHTML = '';
            list.appendChild(btn);

            if (conversations.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'chat-history-empty';
                empty.textContent = 'No conversations yet';
                list.appendChild(empty);
                return;
            }

            // Sort by updated descending
            const sorted = [...conversations].sort((a, b) => b.updated - a.updated);
            for (const conv of sorted) {
                const item = document.createElement('div');
                item.className = 'chat-history-item' + (conv.id === currentConversationId ? ' active' : '');
                const msgCount = conv.messages ? conv.messages.length : 0;
                const timeAgo = formatTimeAgo(conv.updated);
                item.innerHTML = `
                    <div class="chat-history-item-info">
                        <div class="chat-history-item-title">${escapeHtml(conv.title || 'New Chat')}</div>
                        <div class="chat-history-item-meta">${Math.ceil(msgCount / 2)} messages &middot; ${timeAgo}</div>
                    </div>
                    <button class="chat-history-item-delete" title="Delete">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                `;
                item.addEventListener('click', () => loadConversation(conv.id));
                item.querySelector('.chat-history-item-delete').addEventListener('click', (e) => deleteConversation(conv.id, e));
                list.appendChild(item);
            }
        }

        function formatTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return 'just now';
            if (mins < 60) return `${mins}m ago`;
            const hours = Math.floor(mins / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return new Date(timestamp).toLocaleDateString();
        }

        function clearChatUI() {
            const container = document.getElementById('analyzeChatContainer');
            container.innerHTML = '';
            const empty = document.createElement('div');
            empty.className = 'analyze-chat-empty';
            empty.id = 'analyzeChatEmpty';
            empty.innerHTML = `
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity: 0.15;">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <p>Chat with your assets, or select from the asset menu</p>
            `;
            container.appendChild(empty);
            clearQuote();
        }

        function clearChat() {
            chatHistory = [];
            currentConversationId = null;
            clearChatUI();
            saveConversations();
            renderConversationList();
        }

        // Initialize conversation from localStorage on load
        if (currentConversationId) {
            const conv = conversations.find(c => c.id === currentConversationId);
            if (conv) {
                chatHistory = [...conv.messages];
                // Rebuild chat UI on page load (deferred so DOM is ready)
                setTimeout(() => {
                    if (chatHistory.length > 0) {
                        removeEmptyState();
                        for (const msg of chatHistory) {
                            if (msg.role === 'user') {
                                appendUserMessage(msg.content, msg.quoteRefs || null, true);
                            } else if (msg.role === 'assistant') {
                                if (msg.actions && msg.actions.length) {
                                    msg.actions.forEach(action => {
                                        if (action.type === 'search_results') appendAssistantResults(action.results || []);
                                        else if (action.type === 'asset_results') appendAssistantAssetResults(action.results || []);
                                        else if (action.type === 'analysis_text') appendAssistantText(action.text || '', true);
                                        else if (action.type === 'subclip' || action.type === 'concatenation') appendClipResult(action);
                                        else if (action.type === 'error') appendAssistantError(action.message || '');
                                    });
                                    if (msg.content) appendAssistantText(msg.content, true);
                                } else {
                                    appendAssistantText(msg.content, true);
                                }
                            }
                        }
                        scrollChatToBottom();
                        // Add retry button to the last assistant message after replay
                        const allMsgs = document.querySelectorAll('#analyzeChatContainer .chat-message.assistant');
                        if (allMsgs.length) {
                            const lastMsg = allMsgs[allMsgs.length - 1];
                            let toolbar = lastMsg.querySelector('.msg-toolbar');
                            if (!toolbar) {
                                toolbar = document.createElement('div');
                                toolbar.className = 'msg-toolbar';
                                lastMsg.appendChild(toolbar);
                            }
                            if (!toolbar.querySelector('[title="Retry"]')) {
                                const retryBtn = document.createElement('button');
                                retryBtn.title = 'Retry';
                                retryBtn.innerHTML = ICON_RETRY;
                                retryBtn.addEventListener('click', retryLastUserMessage);
                                toolbar.appendChild(retryBtn);
                            }
                        }
                    }
                    renderConversationList();
                }, 100);
            }
        }

        function removeEmptyState() {
            const empty = document.getElementById('analyzeChatEmpty');
            if (empty) empty.remove();
        }

        function scrollChatToBottom() {
            const container = document.getElementById('analyzeChatContainer');
            container.scrollTop = container.scrollHeight;
        }

        const ICON_COPY = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
        const ICON_CHECK = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
        const ICON_RETRY = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>';

        function addMsgToolbar(el, textFn, retryFn, showDownloads) {
            const toolbar = document.createElement('div');
            toolbar.className = 'chat-msg-toolbar';

            // Copy button
            const copyBtn = document.createElement('button');
            copyBtn.title = 'Copy';
            copyBtn.innerHTML = ICON_COPY;
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(textFn()).then(() => {
                    copyBtn.classList.add('copied');
                    copyBtn.innerHTML = ICON_CHECK;
                    setTimeout(() => { copyBtn.classList.remove('copied'); copyBtn.innerHTML = ICON_COPY; }, 1500);
                });
            });
            toolbar.appendChild(copyBtn);

            // Retry button
            if (retryFn) {
                const retryBtn = document.createElement('button');
                retryBtn.title = 'Retry';
                retryBtn.innerHTML = ICON_RETRY;
                retryBtn.addEventListener('click', retryFn);
                toolbar.appendChild(retryBtn);
            }

            // Download format buttons
            if (showDownloads) {
                const sep = document.createElement('span');
                sep.className = 'dl-sep';
                toolbar.appendChild(sep);

                [['TXT', downloadAsTXT], ['JSON', downloadAsJSON], ['DOCX', downloadAsDOCX]].forEach(([label, fn]) => {
                    const btn = document.createElement('button');
                    btn.className = 'dl-btn';
                    btn.title = `Download as ${label}`;
                    btn.textContent = label;
                    btn.addEventListener('click', () => fn(textFn()));
                    toolbar.appendChild(btn);
                });
            }

            el.appendChild(toolbar);
        }

        function downloadAsTXT(text) {
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'response.txt';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function downloadAsJSON(text) {
            const data = {
                content: text,
                timestamp: new Date().toISOString(),
                source: 'TwelveLabs Video Search'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'response.json';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function downloadAsDOCX(text) {
            const html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="utf-8"><style>body{font-family:Calibri,sans-serif;font-size:11pt;line-height:1.6;margin:1in;}</style></head>
<body>${text.replace(/\n/g, '<br>')}</body></html>`;
            const blob = new Blob([html], { type: 'application/msword' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'response.doc';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function retryLastUserMessage() {
            // Find the last user message in chatHistory and re-submit it
            for (let i = chatHistory.length - 1; i >= 0; i--) {
                if (chatHistory[i].role === 'user') {
                    const lastMsg = chatHistory[i];
                    document.getElementById('analyzeInput').value = lastMsg.content;
                    // Remove the last user + assistant pair from history so it gets re-added
                    chatHistory.splice(i);
                    saveChatHistory();
                    handleChatSubmit();
                    return;
                }
            }
        }

        function appendUserMessage(text, quoteRefs, isReplay, videoContext, assetRefs) {
            removeEmptyState();
            const container = document.getElementById('analyzeChatContainer');
            const msg = document.createElement('div');
            msg.className = 'chat-message user';
            let prefixHtml = '';
            const refs = Array.isArray(quoteRefs) ? quoteRefs : (quoteRefs ? [quoteRefs] : []);
            const assets = Array.isArray(assetRefs) ? assetRefs : [];
            if (assets.length) {
                const labels = assets.map(a => escapeHtml(a.name || a.video_id || 'Video')).join(', ');
                prefixHtml = `<div class="chat-user-quote-ref"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line></svg>${labels}</div>`;
            } else if (refs.length) {
                const labels = refs.map(q => `Clip ${q.segment_id} (${formatTime(q.start_time)} - ${formatTime(q.end_time)})`).join(', ');
                prefixHtml = `<div class="chat-user-quote-ref">Re: ${labels}</div>`;
            } else if (videoContext) {
                prefixHtml = `<div class="chat-user-quote-ref"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line></svg>${escapeHtml(videoContext)}</div>`;
            }
            if (prefixHtml) {
                msg.innerHTML = prefixHtml + escapeHtml(text);
            } else {
                msg.textContent = text;
            }
            addMsgToolbar(msg, () => text, isReplay ? null : () => {
                document.getElementById('analyzeInput').value = text;
                handleChatSubmit();
            });
            container.appendChild(msg);
            if (!isReplay) scrollChatToBottom();
        }

        function appendLoadingMessage(label) {
            removeEmptyState();
            const container = document.getElementById('analyzeChatContainer');
            const msg = document.createElement('div');
            msg.className = 'chat-message assistant';
            msg.id = 'chatLoading';
            msg.innerHTML = `
                <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">${escapeHtml(label)}</div>
                <div class="chat-loading-dots"><span></span><span></span><span></span></div>
            `;
            container.appendChild(msg);
            scrollChatToBottom();
            return msg;
        }

        function removeLoadingMessage() {
            const el = document.getElementById('chatLoading');
            if (el) el.remove();
        }

        function buildModalityBarsHtml(modalityScores) {
            if (!modalityScores || !Object.keys(modalityScores).length) return '';
            const maxScore = Math.max(...Object.values(modalityScores), 0.001);
            return `<div class="chat-result-modality-bars">${
                ['visual', 'audio', 'transcription'].map(mod => {
                    const score = modalityScores[mod] || 0;
                    const width = (score / maxScore * 100).toFixed(1);
                    return `<div class="modality-bar"><div class="modality-bar-fill ${mod}" style="width:${width}%"></div></div>`;
                }).join('')
            }</div>`;
        }

        function appendAssistantResults(results) {
            removeLoadingMessage();
            const container = document.getElementById('analyzeChatContainer');
            const msg = document.createElement('div');
            msg.className = 'chat-message assistant';

            if (!results.length) {
                msg.innerHTML = '<span style="color: var(--text-tertiary);">No results found.</span>';
                container.appendChild(msg);
                scrollChatToBottom();
                return;
            }

            const label = document.createElement('div');
            label.className = 'chat-results-label';
            label.textContent = `Found ${results.length} result${results.length > 1 ? 's' : ''}:`;
            msg.appendChild(label);

            const row = document.createElement('div');
            row.className = 'chat-results-row';

            results.forEach((r, idx) => {
                const startTime = formatTime(r.start_time);
                const endTime = formatTime(r.end_time);
                const confidence = Math.round((r.confidence_score !== undefined ? r.confidence_score : r.fusion_score) * 100);

                const card = document.createElement('div');
                card.className = 'chat-result-card';
                card.innerHTML = `
                    <div class="chat-result-thumb">
                        <video muted preload="metadata">
                            <source src="${r.video_url}" type="video/mp4">
                        </video>
                        <span class="chat-result-rank">#${idx + 1}</span>
                        <span class="chat-result-confidence">${confidence}%</span>
                        <span class="chat-result-badge">${startTime} - ${endTime}</span>
                    </div>
                    <div class="chat-result-actions">
                        <span class="chat-result-seg">Seg ${r.segment_id}</span>
                        <button class="chat-result-quote-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Select</button>
                    </div>
                `;

                // Thumbnail seek
                const thumb = card.querySelector('video');
                thumb.addEventListener('loadedmetadata', () => {
                    thumb.currentTime = r.start_time + 1;
                });

                // Click thumbnail → open modal with modality data
                card.querySelector('.chat-result-thumb').addEventListener('click', () => {
                    const videoName = analyzeSelectedVideo ? analyzeSelectedVideo.name : `Segment ${r.segment_id}`;
                    openVideoModal(r.video_url + '#t=' + r.start_time, videoName, r);
                });

                // Quote button
                card.querySelector('.chat-result-quote-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    quoteSegment(r);
                });

                row.appendChild(card);
            });

            msg.appendChild(row);
            container.appendChild(msg);
            scrollChatToBottom();
        }

        function appendAssistantAssetResults(results) {
            removeLoadingMessage();
            const container = document.getElementById('analyzeChatContainer');
            const msg = document.createElement('div');
            msg.className = 'chat-message assistant';

            if (!results.length) {
                msg.innerHTML = '<span style="color: var(--text-tertiary);">No videos found.</span>';
                container.appendChild(msg);
                scrollChatToBottom();
                return;
            }

            const label = document.createElement('div');
            label.className = 'chat-results-label';
            label.textContent = `Found ${results.length} video${results.length > 1 ? 's' : ''}:`;
            msg.appendChild(label);

            const row = document.createElement('div');
            row.className = 'chat-results-row';

            results.forEach((r, idx) => {
                const best = r.best_segment || {};
                const confidence = Math.round((r.best_score || 0) * 100);
                const displayName = r.name || r.video_id || 'Unknown';
                const segments = r.segments || [];

                // Build expandable segments list with individual select buttons
                const segListHtml = segments.map((s, si) => {
                    const segScore = Math.round((s.score || 0) * 100);
                    return `<div class="chat-asset-seg-item" data-seg-idx="${si}" data-start="${s.start_time || 0}" data-url="${s.video_url || r.video_url || ''}">
                        <span class="seg-label">Seg ${s.segment_id}</span>
                        <span class="seg-time">${formatTime(s.start_time || 0)} - ${formatTime(s.end_time || 0)}</span>
                        <span class="seg-score">${segScore}%</span>
                        <button class="seg-select-btn" data-seg-idx="${si}" title="Select this segment">+</button>
                    </div>`;
                }).join('');

                const card = document.createElement('div');
                card.className = 'chat-asset-card';
                card.innerHTML = `
                    <div class="chat-result-thumb">
                        <video muted preload="metadata">
                            <source src="${r.video_url || ''}" type="video/mp4">
                        </video>
                        <span class="chat-result-rank">#${idx + 1}</span>
                        <span class="chat-result-confidence">${confidence}%</span>
                    </div>
                    <div class="chat-asset-info">
                        <div class="chat-asset-name" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}</div>
                        <div class="chat-asset-actions">
                            <span class="chat-asset-meta">${r.segment_count || 0} segments${r.duration ? ' \u2022 ' + formatTime(r.duration) : ''}</span>
                            <button class="chat-result-quote-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Select</button>
                        </div>
                    </div>
                    ${segments.length > 0 ? `
                    <button class="chat-asset-segments-toggle">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        ${segments.length} segment${segments.length > 1 ? 's' : ''}
                    </button>
                    <div class="chat-asset-segments-list">${segListHtml}</div>
                    ` : ''}
                `;

                const thumb = card.querySelector('video');
                thumb.addEventListener('loadedmetadata', () => {
                    thumb.currentTime = (best.start_time || 0) + 1;
                });

                card.querySelector('.chat-result-thumb').addEventListener('click', () => {
                    openVideoModal((r.video_url || '') + '#t=' + (best.start_time || 0), displayName, best);
                });

                // Expand segments toggle
                const toggle = card.querySelector('.chat-asset-segments-toggle');
                if (toggle) {
                    toggle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggle.classList.toggle('open');
                        card.querySelector('.chat-asset-segments-list').classList.toggle('open');
                    });
                }

                // Segment items → click to open modal with modality data, select button to quote
                card.querySelectorAll('.chat-asset-seg-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.seg-select-btn')) return;
                        e.stopPropagation();
                        const seg = segments[parseInt(item.dataset.segIdx)];
                        openVideoModal(item.dataset.url + '#t=' + item.dataset.start, displayName, seg);
                    });
                });

                // Individual segment select buttons ("+")
                card.querySelectorAll('.seg-select-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const seg = segments[parseInt(btn.dataset.segIdx)];
                        if (!seg) return;
                        quoteSegment({
                            video_id: r.video_id,
                            segment_id: seg.segment_id,
                            start_time: seg.start_time,
                            end_time: seg.end_time,
                            video_url: seg.video_url || r.video_url,
                            s3_uri: r.s3_uri,
                            confidence_score: seg.score,
                            modality_scores: seg.modality_scores
                        });
                    });
                });

                // Select Video button → add whole asset to quoted bar
                card.querySelector('.chat-result-quote-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    quoteAsset(r);
                });

                row.appendChild(card);
            });

            msg.appendChild(row);
            container.appendChild(msg);
            scrollChatToBottom();
        }

        function appendToolCallDetails(toolCalls) {
            if (!toolCalls || !toolCalls.length) return;
            const container = document.getElementById('analyzeChatContainer');
            // Attach to the last assistant message instead of creating a new bubble
            const lastMsg = container.querySelector('.chat-message.assistant:last-of-type');

            const details = document.createElement('details');
            details.className = 'chat-tool-details';
            details.innerHTML = `<summary>${toolCalls.length} tool call${toolCalls.length > 1 ? 's' : ''}</summary>`;

            toolCalls.forEach(tc => {
                const div = document.createElement('div');
                div.className = 'chat-tool-call';
                div.innerHTML = `<span class="chat-tool-name">${escapeHtml(tc.name)}</span>(${escapeHtml(JSON.stringify(tc.input))}) → ${escapeHtml(tc.output_summary || '')}`;
                details.appendChild(div);
            });

            if (lastMsg) {
                lastMsg.appendChild(details);
            } else {
                const msg = document.createElement('div');
                msg.className = 'chat-message assistant';
                msg.appendChild(details);
                container.appendChild(msg);
            }
            scrollChatToBottom();
        }

        function appendClipResult(action) {
            removeLoadingMessage();
            const container = document.getElementById('analyzeChatContainer');
            const msg = document.createElement('div');
            msg.className = 'chat-message assistant';

            const isConcat = action.type === 'concatenation';
            const label = isConcat
                ? `Concatenated ${action.clip_count || 0} clips (${action.duration?.toFixed(1) || '?'}s):`
                : `Created subclip (${action.duration?.toFixed(1) || '?'}s):`;

            msg.innerHTML = `
                <div class="chat-clip-result">
                    <div class="chat-clip-label">${escapeHtml(label)}</div>
                    <div class="chat-clip-player">
                        <video controls preload="metadata" style="width:100%;max-height:280px;border-radius:8px;">
                            <source src="${action.video_url || ''}" type="video/mp4">
                        </video>
                    </div>
                    <div class="chat-clip-actions">
                        <a class="chat-clip-action-btn download" href="${action.video_url || ''}" download title="Download clip">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Download
                        </a>
                        <button class="chat-clip-action-btn embed" data-s3-uri="${escapeHtml(action.s3_uri || '')}" title="Create Marengo embeddings for this clip">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            Create Embeddings
                        </button>
                    </div>
                    <div class="chat-clip-publish-row">
                        <span class="publish-label">Publish</span>
                        <a class="chat-publish-btn youtube" href="https://studio.youtube.com/channel/UC/videos/upload" target="_blank" rel="noopener" title="Upload to YouTube Studio">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                            YouTube
                        </a>
                        <a class="chat-publish-btn x" href="https://twitter.com/intent/tweet?text=${encodeURIComponent('Check out this highlight!')}&url=${encodeURIComponent(action.video_url || '')}" target="_blank" rel="noopener" title="Share on X">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            X
                        </a>
                        <a class="chat-publish-btn vimeo" href="https://vimeo.com/upload" target="_blank" rel="noopener" title="Upload to Vimeo">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.977 6.416c-.105 2.338-1.739 5.543-4.894 9.609C15.906 20.348 12.943 22.5 10.5 22.5c-1.484 0-2.738-1.37-3.766-4.11L4.879 12.27c-.703-2.74-1.457-4.11-2.266-4.11-.176 0-.793.37-1.852 1.11L0 8.318c1.164-1.02 2.312-2.04 3.445-3.059C4.98 3.91 6.133 3.21 6.93 3.15c1.82-.176 2.94 1.07 3.363 3.738.457 2.883.773 4.676.95 5.379.527 2.398 1.106 3.598 1.738 3.598.492 0 1.23-.777 2.215-2.332.98-1.555 1.504-2.738 1.574-3.551.14-1.344-.387-2.016-1.586-2.016-.563 0-1.145.129-1.742.387 1.157-3.789 3.367-5.629 6.633-5.52 2.422.071 3.563 1.641 3.422 4.707l-.52-.124z"/></svg>
                            Vimeo
                        </a>
                    </div>
                </div>
            `;

            // Create Embeddings button handler
            msg.querySelector('.chat-clip-action-btn.embed').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                const s3Uri = btn.dataset.s3Uri;
                btn.disabled = true;
                btn.textContent = 'Processing...';
                try {
                    const resp = await fetch('/api/process-video', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ s3_uri: s3Uri })
                    });
                    if (resp.ok) {
                        btn.textContent = 'Embeddings Created';
                        btn.classList.add('success');
                    } else {
                        btn.textContent = 'Failed — Retry';
                        btn.disabled = false;
                    }
                } catch {
                    btn.textContent = 'Failed — Retry';
                    btn.disabled = false;
                }
            });

            container.appendChild(msg);
            scrollChatToBottom();
        }

        function appendAssistantText(text, isReplay) {
            if (!isReplay) removeLoadingMessage();
            const container = document.getElementById('analyzeChatContainer');
            const msg = document.createElement('div');
            msg.className = 'chat-message assistant';
            msg.innerHTML = `<div class="chat-pegasus-text">${escapeHtml(text)}</div>`;
            addMsgToolbar(msg, () => text, isReplay ? null : retryLastUserMessage, true);
            container.appendChild(msg);
            if (!isReplay) scrollChatToBottom();
        }

        function appendAssistantError(text) {
            removeLoadingMessage();
            const container = document.getElementById('analyzeChatContainer');
            const msg = document.createElement('div');
            msg.className = 'chat-message assistant error';
            msg.textContent = text;
            addMsgToolbar(msg, () => text, retryLastUserMessage);
            container.appendChild(msg);
            scrollChatToBottom();
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ── Select segments & assets (multi-select) ──

        let chatQuotedAssets = [];

        function quoteSegment(result) {
            // Avoid duplicates
            if (chatQuotedSegments.find(s => s.segment_id === result.segment_id && s.video_id === result.video_id)) return;
            chatQuotedSegments.push(result);
            renderQuotedBar();
            updateQuotedPlaceholder();
            document.getElementById('analyzeInput').focus();
        }

        function quoteAsset(result) {
            // Avoid duplicates
            if (chatQuotedAssets.find(a => a.video_id === result.video_id)) return;
            chatQuotedAssets.push(result);
            renderQuotedBar();
            updateQuotedPlaceholder();
            document.getElementById('analyzeInput').focus();
        }

        function updateQuotedPlaceholder() {
            const totalItems = chatQuotedSegments.length + chatQuotedAssets.length;
            if (totalItems === 0) {
                if (analyzeSelectedVideo) {
                    document.getElementById('analyzeInput').placeholder = `Chat with ${analyzeSelectedVideo.name}...`;
                } else {
                    document.getElementById('analyzeInput').placeholder = 'Chat with your assets...';
                }
                return;
            }
            const parts = [];
            if (chatQuotedAssets.length) parts.push(`${chatQuotedAssets.length} video${chatQuotedAssets.length > 1 ? 's' : ''}`);
            if (chatQuotedSegments.length) parts.push(`${chatQuotedSegments.length} segment${chatQuotedSegments.length > 1 ? 's' : ''}`);
            document.getElementById('analyzeInput').placeholder = `Ask about ${parts.join(' and ')}...`;
        }

        function removeQuote(type, index) {
            if (type === 'asset') {
                chatQuotedAssets.splice(index, 1);
            } else {
                chatQuotedSegments.splice(index, 1);
            }
            if (chatQuotedSegments.length === 0 && chatQuotedAssets.length === 0) {
                clearQuote();
            } else {
                renderQuotedBar();
                updateQuotedPlaceholder();
            }
        }

        function renderQuotedBar() {
            const bar = document.getElementById('chatQuotedBar');
            const list = document.getElementById('chatQuotedList');
            const hasItems = chatQuotedSegments.length > 0 || chatQuotedAssets.length > 0;
            if (!hasItems) {
                bar.classList.remove('visible');
                return;
            }
            bar.classList.add('visible');

            let html = '';

            // Render asset chips
            chatQuotedAssets.forEach((asset, i) => {
                const displayName = asset.name || asset.video_id || 'Video';
                const confidence = Math.round((asset.best_score || 0) * 100);
                html += `<div class="chat-quoted-chip asset-chip">
                    <video muted preload="metadata" src="${asset.video_url || ''}"></video>
                    <span class="chip-type-badge asset">Video</span>
                    <span>${escapeHtml(displayName)} \u2022 ${asset.segment_count || 0} segs \u2022 ${confidence}%</span>
                    <button class="chat-quoted-chip-remove" data-type="asset" data-idx="${i}" title="Remove">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>`;
            });

            // Render segment chips
            chatQuotedSegments.forEach((seg, i) => {
                const confidence = Math.round((seg.confidence_score !== undefined ? seg.confidence_score : seg.fusion_score) * 100);
                html += `<div class="chat-quoted-chip">
                    <video muted preload="metadata" src="${seg.video_url}"></video>
                    <span class="chip-type-badge clip">Clip</span>
                    <span>Clip ${seg.segment_id} \u2022 ${formatTime(seg.start_time)}-${formatTime(seg.end_time)} \u2022 ${confidence}%</span>
                    <button class="chat-quoted-chip-remove" data-type="segment" data-idx="${i}" title="Remove">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>`;
            });

            list.innerHTML = html;

            // Seek thumbnails for assets
            const assetVideos = list.querySelectorAll('.asset-chip video');
            assetVideos.forEach((v, i) => {
                const best = chatQuotedAssets[i]?.best_segment;
                v.addEventListener('loadedmetadata', () => { v.currentTime = (best?.start_time || 0) + 1; }, { once: true });
            });
            // Seek thumbnails for segments
            const segChips = list.querySelectorAll('.chat-quoted-chip:not(.asset-chip) video');
            segChips.forEach((v, i) => {
                v.addEventListener('loadedmetadata', () => { v.currentTime = chatQuotedSegments[i].start_time + 1; }, { once: true });
            });

            // Remove buttons
            list.querySelectorAll('.chat-quoted-chip-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeQuote(btn.dataset.type, parseInt(btn.dataset.idx));
                });
            });
        }

        function clearQuote() {
            chatQuotedSegments = [];
            chatQuotedAssets = [];
            document.getElementById('chatQuotedBar').classList.remove('visible');
            document.getElementById('chatQuotedList').innerHTML = '';
            if (analyzeSelectedVideo) {
                document.getElementById('analyzeInput').placeholder = `Chat with ${analyzeSelectedVideo.name}...`;
            } else {
                document.getElementById('analyzeInput').placeholder = 'Chat with your assets...';
            }
        }

        // ── Chat search (Marengo — direct) ──
        async function performChatSearch() {
            const input = document.getElementById('analyzeInput');
            const query = input.value.trim();
            if (!query && !chatImageBase64) return;

            const videoCtx = analyzeSelectedVideo ? analyzeSelectedVideo.name : null;
            appendUserMessage(query || 'Image Search', null, false, videoCtx);
            input.value = '';

            // Capture and clear image state
            const imageForSearch = chatImageBase64;
            if (chatImageBase64) {
                chatImageBase64 = null;
                document.getElementById('chatImageUpload').value = '';
                document.getElementById('chatImagePreview').classList.remove('active');
                document.getElementById('chatPreviewImg').src = '';
            }

            const loadingMsg = appendLoadingMessage('Searching with Marengo...');

            const limitMatch = (query || '').match(/\b(?:find|give me|show me|get|top|best|first)\s+(\d{1,2})\b/i);
            const requestedLimit = limitMatch ? Math.min(parseInt(limitMatch[1]), 50) : 20;

            const searchQuery = (query || '')
                .replace(/^(?:find|give me|show me|get|search for|look for)\s+(?:the\s+)?(?:\d+\s+)?(?:best|top|first)?\s*(?:videos?|scenes?|clips?|segments?|moments?|results?)?\s*(?:of|where|with|about|showing|featuring)?\s*/i, '')
                .replace(/^\s+/, '') || query || '';

            const body = {
                query: searchQuery,
                limit: requestedLimit,
                backend: chatSettings.backend,
                use_multi_index: chatSettings.use_multi_index,
                use_decomposition: chatSettings.use_decomposition
            };

            if (imageForSearch) {
                body.query_image = imageForSearch;
            }

            if (chatSettings.fusion_method !== 'dynamic') {
                body.fusion_method = chatSettings.fusion_method;
            }

            if (analyzeSelectedVideo) {
                body.video_id = analyzeSelectedVideo.video_id;
            }

            try {
                const endpoint = chatSettings.fusion_method === 'dynamic' ? '/api/search/dynamic' : '/api/search';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error('Search failed');

                const data = await response.json();
                const results = data.results || [];
                appendAssistantResults(results);
                addSessionCost({ total: 0.012, breakdown: [{ tool: 'marengo_search', label: 'Marengo Search', cost: 0.012 }] });
                chatHistory.push({ role: 'user', content: query });
                chatHistory.push({
                    role: 'assistant',
                    content: `Found ${results.length} results.`,
                    actions: [{ type: 'search_results', results: results.map(stripResultForHistory) }]
                });
                saveChatHistory();
            } catch (err) {
                console.error('Chat search error:', err);
                appendAssistantError('Search failed. Please try again.');
            }
        }

        // ── Pegasus analysis (direct — quoted segment) ──
        async function performPegasusAnalysis() {
            const input = document.getElementById('analyzeInput');
            const prompt = input.value.trim();
            if (!prompt || !chatQuotedSegments.length) return;

            const quoted = chatQuotedSegments[0];
            appendUserMessage(prompt, quoted);
            input.value = '';
            clearQuote();

            const loadingMsg = appendLoadingMessage('Analyzing with Pegasus...');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        s3_uri: quoted.s3_uri,
                        prompt: prompt,
                        start_time: quoted.start_time,
                        end_time: quoted.end_time
                    })
                });

                if (!response.ok) throw new Error('Analysis failed');

                const data = await response.json();
                const responseText = data.response || 'No response from Pegasus.';
                appendAssistantText(responseText);
                addSessionCost({ total: 0.05, breakdown: [{ tool: 'pegasus_analysis', label: 'Pegasus Analysis', cost: 0.05 }] });
                chatHistory.push({
                    role: 'user', content: prompt,
                    quoteRefs: [{ segment_id: quoted.segment_id, start_time: quoted.start_time, end_time: quoted.end_time }]
                });
                chatHistory.push({
                    role: 'assistant', content: responseText,
                    actions: [{ type: 'analysis_text', text: responseText }]
                });
                saveChatHistory();
            } catch (err) {
                console.error('Pegasus error:', err);
                appendAssistantError('Pegasus analysis failed. Please try again.');
            }
        }

        // ── Pegasus analysis (direct — full video, no quote) ──
        async function performDirectPegasus() {
            const input = document.getElementById('analyzeInput');
            const prompt = input.value.trim();
            if (!prompt) return;

            if (!analyzeSelectedVideo) {
                appendAssistantError('Select a video from the left panel first.');
                return;
            }

            if (!analyzeSelectedVideo.s3_uri) {
                appendAssistantError('This video does not have an S3 URI. Try a different video or use Auto mode.');
                return;
            }

            appendUserMessage(prompt, null, false, analyzeSelectedVideo.name);
            input.value = '';

            const loadingMsg = appendLoadingMessage(`Analyzing ${analyzeSelectedVideo.name} with Pegasus...`);

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        s3_uri: analyzeSelectedVideo.s3_uri,
                        prompt: prompt
                    })
                });

                if (!response.ok) throw new Error('Analysis failed');

                const data = await response.json();
                const responseText = data.response || 'No response from Pegasus.';
                appendAssistantText(responseText);
                addSessionCost({ total: 0.05, breakdown: [{ tool: 'pegasus_analysis', label: 'Pegasus Analysis', cost: 0.05 }] });
                chatHistory.push({ role: 'user', content: prompt });
                chatHistory.push({
                    role: 'assistant', content: responseText,
                    actions: [{ type: 'analysis_text', text: responseText }]
                });
                saveChatHistory();
            } catch (err) {
                console.error('Direct Pegasus error:', err);
                appendAssistantError('Pegasus analysis failed. Please try again.');
            }
        }

        // ── Agent chat (Auto mode — Claude decides) ──
        async function performAgentChat() {
            const input = document.getElementById('analyzeInput');
            const message = input.value.trim();
            if (!message && !chatImageBase64) return;

            // Capture and clear image state
            const imageForSearch = chatImageBase64;
            if (chatImageBase64) {
                chatImageBase64 = null;
                document.getElementById('chatImageUpload').value = '';
                document.getElementById('chatImagePreview').classList.remove('active');
                document.getElementById('chatPreviewImg').src = '';
            }

            const quotedSnap = [...chatQuotedSegments];
            const quotedAssetSnap = [...chatQuotedAssets];
            const hasQuoted = quotedSnap.length || quotedAssetSnap.length;

            // Determine video context label for chat bubble
            let videoCtxLabel = null;
            if (!quotedSnap.length && !quotedAssetSnap.length && analyzeSelectedVideo) {
                videoCtxLabel = analyzeSelectedVideo.name;
            }
            appendUserMessage(message || 'Image Search', quotedSnap.length ? quotedSnap : null, false, videoCtxLabel, quotedAssetSnap.length ? quotedAssetSnap : null);
            input.value = '';
            if (hasQuoted) clearQuote();

            const loadingMsg = appendLoadingMessage('Agent thinking...');

            const context = { settings: { ...chatSettings } };
            if (imageForSearch) {
                context.query_image = imageForSearch;
            }

            // Include all selected videos from sidebar
            const allSelectedVideos = getSelectedVideos();
            if (allSelectedVideos.length > 0) {
                context.selected_video = {
                    video_id: allSelectedVideos[0].video_id,
                    s3_uri: allSelectedVideos[0].s3_uri || '',
                    name: allSelectedVideos[0].name
                };
                if (allSelectedVideos.length > 1) {
                    context.selected_videos = allSelectedVideos.map(v => ({
                        video_id: v.video_id,
                        s3_uri: v.s3_uri || '',
                        name: v.name
                    }));
                }
            } else if (analyzeSelectedVideo) {
                context.selected_video = {
                    video_id: analyzeSelectedVideo.video_id,
                    s3_uri: analyzeSelectedVideo.s3_uri || '',
                    name: analyzeSelectedVideo.name
                };
            }

            if (quotedSnap.length) {
                context.quoted_segments = quotedSnap.map(q => ({
                    video_id: q.video_id,
                    segment_id: q.segment_id,
                    start_time: q.start_time,
                    end_time: q.end_time,
                    s3_uri: q.s3_uri || ''
                }));
            }

            // Include quoted assets (selected from asset search results)
            if (quotedAssetSnap.length) {
                context.selected_videos = quotedAssetSnap.map(a => ({
                    video_id: a.video_id,
                    s3_uri: a.s3_uri || '',
                    name: a.name || a.video_id
                }));
                if (!context.selected_video) {
                    context.selected_video = context.selected_videos[0];
                }
            }

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        chat_history: chatHistory.slice(-20),
                        context: context
                    })
                });

                if (!response.ok) throw new Error('Agent chat failed');

                const data = await response.json();

                // Render actions
                (data.actions || []).forEach(action => {
                    if (action.type === 'search_results') {
                        appendAssistantResults(action.results || []);
                    } else if (action.type === 'asset_results') {
                        appendAssistantAssetResults(action.results || []);
                    } else if (action.type === 'analysis_text') {
                        appendAssistantText(action.text || '');
                    } else if (action.type === 'subclip' || action.type === 'concatenation') {
                        appendClipResult(action);
                    } else if (action.type === 'error') {
                        appendAssistantError(action.message || 'An error occurred.');
                    }
                });

                // Render agent message
                if (data.message) {
                    appendAssistantText(data.message);
                }

                // Render tool call details (collapsible)
                if (data.tool_calls && data.tool_calls.length) {
                    appendToolCallDetails(data.tool_calls);
                }

                // Track session cost
                if (data.costs) addSessionCost(data.costs);

                // Build history actions (stripped for localStorage)
                const historyActions = (data.actions || []).map(action => {
                    if (action.type === 'search_results') {
                        return { type: 'search_results', results: (action.results || []).map(stripResultForHistory) };
                    } else if (action.type === 'asset_results') {
                        return { type: 'asset_results', results: (action.results || []).map(stripAssetForHistory) };
                    } else if (action.type === 'analysis_text') {
                        return { type: 'analysis_text', text: action.text || '' };
                    } else if (action.type === 'subclip' || action.type === 'concatenation') {
                        return { type: action.type, video_url: action.video_url, s3_uri: action.s3_uri, duration: action.duration, clip_count: action.clip_count };
                    } else if (action.type === 'error') {
                        return { type: 'error', message: action.message || '' };
                    }
                    return action;
                });

                // Update chat history
                const userEntry = { role: 'user', content: message };
                if (quotedSnap.length) {
                    userEntry.quoteRefs = quotedSnap.map(q => ({ segment_id: q.segment_id, start_time: q.start_time, end_time: q.end_time }));
                }
                chatHistory.push(userEntry);
                chatHistory.push({
                    role: 'assistant',
                    content: data.message || '',
                    actions: historyActions
                });
                saveChatHistory();
            } catch (err) {
                console.error('Agent chat error:', err);
                removeLoadingMessage();
                appendAssistantError('Agent failed. Please try again.');
            }
        }

        // ── Unified submit handler (mode-aware) ──
        function handleChatSubmit() {
            if (chatModelMode === 'marengo') {
                performChatSearch();
            } else if (chatModelMode === 'pegasus') {
                if (chatQuotedSegments.length) {
                    performPegasusAnalysis();
                } else {
                    performDirectPegasus();
                }
            } else {
                // Auto mode — agent decides
                performAgentChat();
            }
        }

        // ── Model selector ──
        document.querySelectorAll('.chat-model-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.chat-model-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                chatModelMode = btn.dataset.model;
            });
        });

        // ── Chat settings panel ──
        document.getElementById('chatSettingsBtn').addEventListener('click', () => {
            const panel = document.getElementById('chatSettingsPanel');
            const btn = document.getElementById('chatSettingsBtn');
            panel.classList.toggle('open');
            btn.classList.toggle('active', panel.classList.contains('open'));
        });

        // Search mode pills
        document.querySelectorAll('.chat-mode-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('.chat-mode-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                chatSettings.fusion_method = pill.dataset.mode;
            });
        });

        // Backend select
        document.getElementById('chatBackendSelect').addEventListener('change', (e) => {
            chatSettings.backend = e.target.value;
        });

        // Index mode toggle
        document.getElementById('chatIndexToggle').addEventListener('change', (e) => {
            chatSettings.use_multi_index = e.target.checked;
            document.getElementById('chatIndexIndicator').textContent = e.target.checked ? 'Multi-Index' : 'Unified';
        });

        // Decomposition toggle
        document.getElementById('chatDecompToggle').addEventListener('change', (e) => {
            chatSettings.use_decomposition = e.target.checked;
        });

        // Chat image upload handler
        document.getElementById('chatImageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                e.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(ev) {
                chatImageBase64 = ev.target.result.split(',')[1];
                document.getElementById('chatPreviewImg').src = ev.target.result;
                document.getElementById('chatImagePreview').classList.add('active');
            };
            reader.readAsDataURL(file);
        });

        // Remove chat image
        document.getElementById('chatRemoveImage').addEventListener('click', function() {
            chatImageBase64 = null;
            document.getElementById('chatImageUpload').value = '';
            document.getElementById('chatImagePreview').classList.remove('active');
            document.getElementById('chatPreviewImg').src = '';
        });

        // Close settings panel on outside click
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('chatSettingsPanel');
            const btn = document.getElementById('chatSettingsBtn');
            if (panel.classList.contains('open') && !panel.contains(e.target) && !btn.contains(e.target)) {
                panel.classList.remove('open');
                btn.classList.remove('active');
            }
        });

        // Analyze event listeners
        document.getElementById('analyzeSendBtn').addEventListener('click', handleChatSubmit);
        document.getElementById('analyzeInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleChatSubmit();
        });
        document.getElementById('analyzeClearVideo').addEventListener('click', clearAnalyzeVideo);
        document.getElementById('chatQuotedDismiss').addEventListener('click', clearQuote);

        // Sidebar tabs: Assets / History
        document.querySelectorAll('.analyze-sidebar-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.analyze-sidebar-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const isHistory = tab.dataset.tab === 'history';
                document.getElementById('analyzeAssetList').style.display = isHistory ? 'none' : '';
                document.getElementById('chatHistoryList').classList.toggle('visible', isHistory);
                if (isHistory) renderConversationList();
            });
        });
        document.getElementById('newChatBtn').addEventListener('click', newConversation);

        // Search from Indexes/Analyze page → switch to Home with results
        const origPerformSearch = performSearch;
        // Wrap search to ensure we're on Home view
        const searchInputEl = document.getElementById('searchInput');
        const searchBtnEl = document.getElementById('searchBtn');

        function ensureHomeBeforeSearch() {
            const indexesView = document.getElementById('indexesView');
            const analyzeView = document.getElementById('analyzeView');
            if (indexesView.style.display !== 'none' || analyzeView.style.display !== 'none') {
                switchToPage('home');
                // Don't clear search since we want to execute it
            }
        }

        searchBtnEl.addEventListener('click', ensureHomeBeforeSearch, true);
        searchInputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') ensureHomeBeforeSearch();
        }, true);
    </script>
</body>
</html>
